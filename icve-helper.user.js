// ==UserScript==
// @name         æ™ºæ…§èŒæ•™å…¨èƒ½åŠ©æ‰‹
// @namespace    http://tampermonkey.net/
// @version      1.3.0
// @description  æ™ºæ…§èŒæ•™MOOCå­¦ä¹ åŠ©æ‰‹ï¼šä»…æ”¯æŒæ™ºæ…§èŒæ•™MOOCå¹³å°ï¼Œé›†æˆè‡ªåŠ¨å­¦ä¹ å’ŒAIæ™ºèƒ½ç­”é¢˜åŠŸèƒ½
// @author       caokun
// @license      MIT
// @icon         https://www.icve.com.cn/favicon.ico
// @match        https://*.icve.com.cn/excellent-study/*
// @match        https://*.icve.com.cn/preview-exam/*
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// @connect      *
// @run-at       document-idle
// @updateURL    https://raw.githubusercontent.com/hearthealt/Smart-Vocational-Education/master/icve-helper.user.js
// @downloadURL  https://raw.githubusercontent.com/hearthealt/Smart-Vocational-Education/master/icve-helper.user.js
// @homepageURL  https://github.com/hearthealt/Smart-Vocational-Education
// @supportURL   https://github.com/hearthealt/Smart-Vocational-Education/issues
// @note         https://raw.githubusercontent.com/hearthealt/Smart-Vocational-Education/master/README.md
// ==/UserScript==

(function() {
    'use strict';

    // ==================== å·¥å…·å‡½æ•°æ¨¡å— ====================
    const Utils = {
        // å»¶æ—¶å‡½æ•°
        sleep: (ms) => new Promise(resolve => setTimeout(resolve, ms)),

        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’è½¬ä¸º MM:SS æ ¼å¼ï¼‰
        formatTime: (seconds) => {
            if (!seconds || isNaN(seconds) || seconds === Infinity) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        },

        // é˜²æŠ–å‡½æ•°
        debounce: (fn, delay = 300) => {
            let timer = null;
            return function(...args) {
                if (timer) clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        },

        // èŠ‚æµå‡½æ•°
        throttle: (fn, delay = 300) => {
            let lastTime = 0;
            return function(...args) {
                const now = Date.now();
                if (now - lastTime >= delay) {
                    lastTime = now;
                    return fn.apply(this, args);
                }
            };
        },

        // å®‰å…¨è·å–DOMå…ƒç´ 
        $(selector, parent = document) {
            return parent.querySelector(selector);
        },

        // å®‰å…¨è·å–å¤šä¸ªDOMå…ƒç´ 
        $$(selector, parent = document) {
            return Array.from(parent.querySelectorAll(selector));
        },

        // å¸¦é‡è¯•çš„å¼‚æ­¥æ“ä½œ
        async retry(fn, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await this.sleep(delay);
                }
            }
        }
    };

    // ==================== æ—¥å¿—ç³»ç»Ÿ ====================
    const Logger = {
        _prefix: '[æ™ºæ…§èŒæ•™åŠ©æ‰‹]',
        _maxLogs: 100, // æœ€å¤§æ—¥å¿—æ¡æ•°
        _logs: [], // å­˜å‚¨æ—¥å¿—æ•°æ®

        _log(level, ...args) {
            const timestamp = new Date().toLocaleTimeString();

            // æ·»åŠ åˆ°é¡µé¢æ—¥å¿—
            this._addPageLog(level, timestamp, args);
        },

        _addPageLog(level, timestamp, args) {
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
            ).join(' ');
            
            const logEntry = {
                level,
                timestamp,
                message,
                id: Date.now() + Math.random()
            };
            
            this._logs.push(logEntry);
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (this._logs.length > this._maxLogs) {
                this._logs.shift();
            }
            
            // æ›´æ–°é¡µé¢æ—¥å¿—æ˜¾ç¤º
            this._updatePageLog(logEntry);
            
            // æ›´æ–°æ—¥å¿—è®¡æ•°å™¨
            updateLogCount();
        },

        _updatePageLog(logEntry) {
            const container = document.getElementById('page-log-container');
            if (!container) return;

            // ç§»é™¤å ä½ç¬¦ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const placeholder = container.querySelector('.log-placeholder');
            if (placeholder) {
                placeholder.remove();
            }

            const logElement = this._createLogElement(logEntry);
            container.appendChild(logElement);

            // é™åˆ¶DOMä¸­çš„æ—¥å¿—æ•°é‡
            while (container.children.length > this._maxLogs) {
                container.removeChild(container.firstChild);
            }

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        },

        _createLogElement(logEntry) {
            const div = document.createElement('div');
            div.className = `log-entry log-${logEntry.level}`;
            div.innerHTML = `
                <span class="log-time">${logEntry.timestamp}</span>
                <span class="log-icon">${this._getLogIcon(logEntry.level)}</span>
                <span class="log-message">${logEntry.message}</span>
            `;
            return div;
        },

        _getLogIcon(level) {
            const icons = {
                info: 'â„¹ï¸',
                success: 'âœ…',
                warn: 'âš ï¸',
                error: 'âŒ'
            };
            return icons[level] || 'â„¹ï¸';
        },

        clearPageLog() {
            this._logs = [];
            const container = document.getElementById('page-log-container');
            if (container) {
                container.innerHTML = '<div class="log-placeholder">æš‚æ— æ—¥å¿—è®°å½•</div>';
            }
            updateLogCount();
        },

        info(...args) { this._log('info', ...args); },
        success(...args) { this._log('success', ...args); },
        warn(...args) { this._log('warn', ...args); },
        error(...args) { this._log('error', ...args); }
    };

    // ==================== DOMå…ƒç´ ç¼“å­˜ ====================
    const DOMCache = {
        _cache: new Map(),
        _maxAge: 5000, // ç¼“å­˜5ç§’

        get(selector, forceRefresh = false) {
            const now = Date.now();
            const cached = this._cache.get(selector);

            if (!forceRefresh && cached && (now - cached.time < this._maxAge)) {
                return cached.element;
            }

            const element = document.querySelector(selector);
            if (element) {
                this._cache.set(selector, { element, time: now });
            }
            return element;
        }
    };

    // ==================== AIæ¨¡å‹é¢„è®¾é…ç½® ====================
    const AI_PRESETS = {
        qwen: {
            name: 'é€šä¹‰åƒé—®',
            baseURL: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
            model: 'qwen-max',
            defaultKey: '',
            keyPlaceholder: 'sk-xxx'
        },
        gpt: {
            name: 'OpenAI GPT',
            baseURL: 'https://api.openai.com/v1',
            model: 'gpt-4o-mini',
            defaultKey: '',
            keyPlaceholder: 'sk-xxx'
        },
        deepseek: {
            name: 'DeepSeek',
            baseURL: 'https://api.deepseek.com/v1',
            model: 'deepseek-chat',
            defaultKey: '',
            keyPlaceholder: 'sk-xxx'
        },
        kimi: {
            name: 'Moonshot AI (Kimi)',
            baseURL: 'https://api.moonshot.cn/v1',
            model: 'moonshot-v1-8k',
            defaultKey: '',
            keyPlaceholder: 'sk-xxx'
        },
        zhipu: {
            name: 'æ™ºè°±AI (GLM)',
            baseURL: 'https://open.bigmodel.cn/api/paas/v4',
            model: 'glm-4',
            defaultKey: '',
            keyPlaceholder: 'xxx.xxx'
        },
        custom: {
            name: 'è‡ªå®šä¹‰',
            baseURL: '',
            model: '',
            defaultKey: '',
            keyPlaceholder: 'your-api-key'
        }
    };

    // ==================== é…ç½®ç®¡ç†ï¼ˆç»Ÿä¸€å­˜å‚¨é€»è¾‘ï¼‰ ====================
    const ConfigManager = {
        // é…ç½®é”®åæ˜ å°„
        keys: {
            learning: {
                playbackRate: 'learning_playbackRate',
                waitTimeAfterComplete: 'learning_waitTime',
                documentPageInterval: 'learning_docInterval',
                expandDelay: 'learning_expandDelay',
                muteMedia: 'learning_muteMedia'
            },
            exam: {
                delay: 'exam_delay',
                autoSubmit: 'exam_autoSubmit',
                currentAI: 'exam_currentAI'
            },
            progress: {
                processedNodes: 'learning_processedNodes',
                completedChapters: 'learning_completedChapters'
            }
        },

        // é»˜è®¤å€¼
        defaults: {
            learning: {
                playbackRate: 1.0,
                waitTimeAfterComplete: 2,
                documentPageInterval: 1,
                expandDelay: 3,
                muteMedia: false
            },
            exam: {
                delay: 3000,
                autoSubmit: false,
                currentAI: 'qwen'
            }
        },

        // è·å–é…ç½®å€¼
        get(category, key) {
            const storageKey = this.keys[category]?.[key];
            const defaultValue = this.defaults[category]?.[key];
            if (storageKey) {
                return GM_getValue(storageKey, defaultValue);
            }
            return defaultValue;
        },

        // æ‰¹é‡ä¿å­˜é…ç½®
        saveAll(config) {
            // ä¿å­˜å­¦ä¹ é…ç½®
            Object.keys(this.keys.learning).forEach(key => {
                if (config.learning && config.learning[key] !== undefined) {
                    GM_setValue(this.keys.learning[key], config.learning[key]);
                }
            });

            // ä¿å­˜ç­”é¢˜é…ç½®
            Object.keys(this.keys.exam).forEach(key => {
                if (config.exam && config.exam[key] !== undefined) {
                    GM_setValue(this.keys.exam[key], config.exam[key]);
                }
            });

            // ä¿å­˜ä¸»é¢˜åˆ°localStorage
            if (config.theme) {
                localStorage.setItem('icve_theme_mode', config.theme);
            }
        },

        // è·å–AIé…ç½®
        getAIConfig(aiType) {
            const preset = AI_PRESETS[aiType];
            return {
                apiKey: GM_getValue(`ai_key_${aiType}`, preset.defaultKey),
                baseURL: GM_getValue(`ai_baseurl_${aiType}`, preset.baseURL),
                model: GM_getValue(`ai_model_${aiType}`, preset.model)
            };
        }
    };

    // å…¼å®¹æ—§æ¥å£çš„é…ç½®å¯¹è±¡
    const CONFIG = {
        learning: {
            playbackRate: ConfigManager.get('learning', 'playbackRate'),
            waitTimeAfterComplete: ConfigManager.get('learning', 'waitTimeAfterComplete'),
            documentPageInterval: ConfigManager.get('learning', 'documentPageInterval'),
            expandDelay: ConfigManager.get('learning', 'expandDelay'),
            muteMedia: ConfigManager.get('learning', 'muteMedia'),
        },
        exam: {
            delay: ConfigManager.get('exam', 'delay'),
            autoSubmit: ConfigManager.get('exam', 'autoSubmit'),
            currentAI: ConfigManager.get('exam', 'currentAI'),
        },
        theme: localStorage.getItem('icve_theme_mode') || 'light',
        currentTab: 'learning',
    };

    // AIé…ç½®
    function getAIConfig() {
        return ConfigManager.getAIConfig(CONFIG.exam.currentAI);
    }

    // ä¿å­˜é…ç½®ï¼ˆä½¿ç”¨ConfigManagerï¼‰
    function saveConfig() {
        ConfigManager.saveAll(CONFIG);
    }

    // ä¿å­˜å­¦ä¹ è¿›åº¦æ•°æ®
    function saveLearningProgress() {
        GM_setValue(ConfigManager.keys.progress.processedNodes, Array.from(state.learning.processedNodes));
        GM_setValue(ConfigManager.keys.progress.completedChapters, Array.from(state.learning.completedChapters));
    }

    // ==================== çŠ¶æ€ç®¡ç† ====================
    const state = {
        // å­¦ä¹ æ¨¡å¼çŠ¶æ€
        learning: {
            isRunning: false,
            currentNode: null,
            allNodes: [],
            completedCount: 0,
            totalCount: 0,
            examCount: 0,
            processedNodes: new Set(GM_getValue(ConfigManager.keys.progress.processedNodes, [])),
            completedChapters: new Set(GM_getValue(ConfigManager.keys.progress.completedChapters, [])),
        },
        // ç­”é¢˜æ¨¡å¼çŠ¶æ€
        exam: {
            isRunning: false,
            currentQuestionIndex: 0,
            totalQuestions: 0,
        }
    };

    // ==================== åˆ›å»ºä¸»é¢æ¿ ====================
    // åˆ¤æ–­å½“å‰é¡µé¢ç±»å‹
    function getPageType() {
        const url = window.location.href;
        if (url.includes('/excellent-study/')) {
            return 'learning';
        } else if (url.includes('/preview-exam/')) {
            return 'exam';
        }
        return 'all';
    }

    function createPanel() {
        const panel = document.createElement('div');
        panel.id = 'icve-tabbed-panel';

        const pageType = getPageType();
        const showLearning = pageType === 'learning' || pageType === 'all';
        const showExam = pageType === 'exam' || pageType === 'all';

        // æ ¹æ®é¡µé¢ç±»å‹ç¡®å®šé»˜è®¤æ ‡ç­¾é¡µ
        const defaultTab = pageType === 'exam' ? 'exam' : 'learning';

        panel.innerHTML = `
            <div class="panel-container">
                <!-- å¤´éƒ¨ï¼šæ ‡é¢˜ + æ§åˆ¶æŒ‰é’® -->
                <div class="panel-header" id="panel-header">
                    <span class="panel-title">ğŸ“ æ™ºæ…§èŒæ•™å…¨èƒ½åŠ©æ‰‹</span>
                    <div class="header-controls">
                        <button class="theme-toggle" id="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
                        <button class="panel-toggle" id="panel-toggle" title="æŠ˜å /å±•å¼€">âˆ’</button>
                    </div>
                </div>

                <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
                <div class="tab-nav">
                    ${showLearning ? `<button class="tab-btn${defaultTab === 'learning' ? ' active' : ''}" data-tab="learning">ğŸ“š å­¦ä¹ </button>` : ''}
                    ${showExam ? `<button class="tab-btn${defaultTab === 'exam' ? ' active' : ''}" data-tab="exam">ğŸ¤– ç­”é¢˜</button>` : ''}
                    <button class="tab-btn" data-tab="log">ğŸ“‹ æ—¥å¿—</button>
                </div>

                <!-- æ ‡ç­¾é¡µå†…å®¹ -->
                <div class="tab-content-wrapper" id="tab-content-wrapper">
                    ${showLearning ? `<!-- å­¦ä¹ æ ‡ç­¾é¡µ -->
                    <div class="tab-pane${defaultTab === 'learning' ? ' active' : ''}" id="tab-learning">
                        ${createLearningTab()}
                    </div>` : ''}

                    ${showExam ? `<!-- ç­”é¢˜æ ‡ç­¾é¡µ -->
                    <div class="tab-pane${defaultTab === 'exam' ? ' active' : ''}" id="tab-exam">
                        ${createExamTab()}
                    </div>` : ''}

                    <!-- æ—¥å¿—æ ‡ç­¾é¡µ -->
                    <div class="tab-pane" id="tab-log">
                        ${createLogTab()}
                    </div>
                </div>
            </div>
        `;

        // æ·»åŠ æ ·å¼
        addStyles();

        document.body.appendChild(panel);

        // ç»‘å®šäº‹ä»¶
        bindEvents();

        // åº”ç”¨ä¸»é¢˜
        applyTheme(CONFIG.theme);

        // æ¢å¤æŠ˜å çŠ¶æ€
        restorePanelState();

        // è®¾ç½®é»˜è®¤æ ‡ç­¾é¡µï¼ˆä¸ä½¿ç”¨ä¿å­˜çš„ï¼Œæ ¹æ®é¡µé¢ç±»å‹å†³å®šï¼‰
        switchTab(defaultTab);
    }

    // ==================== åˆ›å»ºå­¦ä¹ æ ‡ç­¾é¡µ ====================
    function createLearningTab() {
        return `
            <div class="tab-inner">
                <!-- çŠ¶æ€åŒºåŸŸ -->
                <div class="learning-status-section">
                    <div class="status-row">
                        <span class="status-item">
                            <span class="status-dot" id="learning-status-dot"></span>
                            <span id="learning-status">åœæ­¢ä¸­</span>
                        </span>
                        <span class="status-item">
                            <span>ğŸ“Š</span>
                            <span id="learning-progress">0/0</span>
                        </span>
                        <span class="status-item">
                            <span>âœ…</span>
                            <span><span id="learning-processed">0</span>ä¸ª</span>
                        </span>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="learning-progress-bar" data-progress="0%"></div>
                    </div>
                    <div class="current-node">
                        <span class="node-icon">ğŸ“–</span>
                        <span class="node-text" id="learning-current" title="">ç­‰å¾…å¼€å§‹...</span>
                    </div>
                </div>

                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="learning-controls">
                    <button class="btn btn-primary btn-large" id="learning-start">â–¶ï¸ å¼€å§‹å­¦ä¹ </button>
                    <div class="btn-group">
                        <button class="btn btn-outline" id="learning-scan">ğŸ” æ‰«æ</button>
                        <button class="btn btn-outline" id="learning-reset">ğŸ”„ é‡ç½®</button>
                        <label class="btn btn-outline btn-toggle-label">
                            <input type="checkbox" id="learning-mute-media" ${CONFIG.learning.muteMedia ? 'checked' : ''} hidden>
                            <span class="toggle-icon">${CONFIG.learning.muteMedia ? 'ğŸ”‡' : 'ğŸ”Š'}</span>
                            <span>é™éŸ³</span>
                        </label>
                    </div>
                </div>

                <!-- å­¦ä¹ é…ç½® -->
                <div class="settings-section">
                    <div class="section-header">
                        <h3>âš™ï¸ å­¦ä¹ é…ç½®</h3>
                    </div>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label class="setting-label">æ’­æ”¾å€é€Ÿ</label>
                            <select id="learning-playback-rate" class="select-control">
                                <option value="1.0" ${CONFIG.learning.playbackRate === 1.0 ? 'selected' : ''}>1.0x</option>
                                <option value="1.5" ${CONFIG.learning.playbackRate === 1.5 ? 'selected' : ''}>1.5x</option>
                                <option value="2.0" ${CONFIG.learning.playbackRate === 2.0 ? 'selected' : ''}>2.0x</option>
                                <option value="3.0" ${CONFIG.learning.playbackRate === 3.0 ? 'selected' : ''}>3.0x</option>
                                <option value="4.0" ${CONFIG.learning.playbackRate === 4.0 ? 'selected' : ''}>4.0x</option>
                                <option value="6.0" ${CONFIG.learning.playbackRate === 6.0 ? 'selected' : ''}>6.0x</option>
                                <option value="8.0" ${CONFIG.learning.playbackRate === 8.0 ? 'selected' : ''}>8.0x</option>
                                <option value="16.0" ${CONFIG.learning.playbackRate === 16.0 ? 'selected' : ''}>16.0x</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">å®Œæˆç­‰å¾…</label>
                            <div class="input-with-unit">
                                <input type="number" id="learning-wait-time" class="input-control"
                                       value="${CONFIG.learning.waitTimeAfterComplete}" min="1" max="30">
                                <span class="unit">ç§’</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">ç¿»é¡µé—´éš”</label>
                            <div class="input-with-unit">
                                <input type="number" id="learning-doc-interval" class="input-control"
                                       value="${CONFIG.learning.documentPageInterval}" min="1" max="60">
                                <span class="unit">ç§’</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">å±•å¼€å»¶è¿Ÿ</label>
                            <div class="input-with-unit">
                                <input type="number" id="learning-expand-delay" class="input-control"
                                       value="${CONFIG.learning.expandDelay}" min="1" max="10" step="0.5">
                                <span class="unit">ç§’</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ==================== åˆ›å»ºæ—¥å¿—æ ‡ç­¾é¡µ ====================
    function createLogTab() {
        return `
            <div class="log-tab-container">
                <div class="log-container" id="page-log-container">
                    <div class="log-placeholder">æš‚æ— æ—¥å¿—è®°å½•</div>
                </div>
                <div class="log-footer">
                    <span class="log-count-text" id="log-count">0 æ¡è®°å½•</span>
                    <button class="btn btn-secondary btn-clear-log" id="clear-page-log">ğŸ—‘ æ¸…ç©ºæ—¥å¿—</button>
                </div>
            </div>
        `;
    }

    // ==================== åˆ›å»ºç­”é¢˜æ ‡ç­¾é¡µ ====================
    function createExamTab() {
        let aiOptions = '';
        for (const [key, preset] of Object.entries(AI_PRESETS)) {
            const selected = CONFIG.exam.currentAI === key ? 'selected' : '';
            aiOptions += `<option value="${key}" ${selected}>${preset.name}</option>`;
        }

        const aiConfig = getAIConfig();

        return `
            <div class="tab-inner">
                <!-- çŠ¶æ€å¡ç‰‡ - ç´§å‡‘å‹ -->
                <div class="status-card-compact">
                    <div class="status-inline">
                        <span class="status-badge">
                            <span class="badge-icon">ğŸ¯</span>
                            <span class="badge-value" id="exam-status">å°±ç»ª</span>
                        </span>
                        <span class="status-badge">
                            <span class="badge-icon">ğŸ“Š</span>
                            <span class="badge-value" id="exam-progress">0/0</span>
                        </span>
                        <span class="status-badge">
                            <span class="badge-icon">ğŸ¤–</span>
                            <span class="badge-value">${AI_PRESETS[CONFIG.exam.currentAI].name}</span>
                        </span>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="exam-progress-bar" data-progress="0%"></div>
                    </div>
                </div>

                <!-- å¿«é€Ÿé…ç½®æ  -->
                <div class="quick-config">
                    <div class="config-item config-ai">
                        <label class="config-label">ğŸ”®</label>
                        <select id="exam-ai-model" class="select-control select-compact">
                            ${aiOptions}
                        </select>
                    </div>
                    <div class="config-item config-delay">
                        <label class="config-label">â±ï¸</label>
                        <div class="input-with-unit-inline">
                            <input type="number" id="exam-delay" class="input-control input-compact"
                                   value="${CONFIG.exam.delay / 1000}" min="2" max="15">
                            <span class="unit">ç§’</span>
                        </div>
                    </div>
                    <div class="config-item config-submit">
                        <label class="switch-item-inline">
                            <input type="checkbox" id="exam-auto-submit" ${CONFIG.exam.autoSubmit ? 'checked' : ''}>
                            <span class="switch-label-inline">è‡ªåŠ¨äº¤å·</span>
                        </label>
                    </div>
                </div>

                <!-- APIå¯†é’¥è¾“å…¥ -->
                <div class="api-key-section">
                    <div class="api-key-header">
                        <span class="api-icon">ğŸ”‘</span>
                        <span class="api-label">API Key</span>
                        <small class="api-hint">éœ€è¦å¯†é’¥æ‰èƒ½ä½¿ç”¨AIç­”é¢˜</small>
                    </div>
                    <input type="text" id="exam-api-key" class="input-control input-api-key"
                           value="${aiConfig.apiKey}"
                           placeholder="${AI_PRESETS[CONFIG.exam.currentAI].keyPlaceholder}">
                </div>

                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="control-buttons-group">
                    <div class="primary-actions">
                        <button class="btn btn-primary btn-start" id="exam-start">â–¶ï¸ å¼€å§‹ç­”é¢˜</button>
                        <button class="btn btn-primary btn-stop" id="exam-stop" disabled>â¹ åœæ­¢ç­”é¢˜</button>
                    </div>
                </div>

                <!-- é«˜çº§é…ç½® -->
                <details class="advanced-settings">
                    <summary>âš™ï¸ é«˜çº§é…ç½®ï¼ˆå¯é€‰ï¼‰</summary>
                    <div class="advanced-content">
                        <div class="advanced-item">
                            <label>
                                <span class="label-icon">ğŸŒ</span>
                                <span>API åœ°å€</span>
                            </label>
                            <input type="text" id="exam-api-url" class="input-control"
                                   value="${aiConfig.baseURL}"
                                   placeholder="https://api.example.com/v1">
                            <small class="hint">é»˜è®¤ä½¿ç”¨å®˜æ–¹åœ°å€ï¼Œå¦‚éœ€ä½¿ç”¨ä»£ç†å¯ä¿®æ”¹</small>
                        </div>
                        <div class="advanced-item">
                            <label>
                                <span class="label-icon">ğŸ¯</span>
                                <span>æ¨¡å‹åç§°</span>
                            </label>
                            <input type="text" id="exam-api-model-name" class="input-control"
                                   value="${aiConfig.model}"
                                   placeholder="gpt-4">
                            <small class="hint">é»˜è®¤ä½¿ç”¨æ¨èæ¨¡å‹ï¼Œé«˜çº§ç”¨æˆ·å¯è‡ªå®šä¹‰</small>
                        </div>
                    </div>
                </details>

                <!-- çŠ¶æ€æ¶ˆæ¯ -->
                <div class="status-message" id="exam-message">
                    ğŸ’¡ é…ç½®å®Œæˆåç‚¹å‡»"å¼€å§‹ç­”é¢˜"
                </div>
            </div>
        `;
    }

    // ==================== æ·»åŠ æ ·å¼ ====================
    function addStyles() {
        const style = document.createElement('style');
        style.textContent = `
            /* ==================== å¯¼å…¥å­—ä½“ ==================== */
            @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');

            /* ==================== CSS å˜é‡ç³»ç»Ÿ ==================== */
            :root {
                /* ä¸»è‰²è°ƒ - æå…‰æ¸å˜ç³» */
                --icve-primary-from: #6366f1;
                --icve-primary-via: #8b5cf6;
                --icve-primary-to: #d946ef;
                --icve-primary-glow: rgba(139, 92, 246, 0.4);

                /* åŠŸèƒ½è‰² */
                --icve-success-from: #10b981;
                --icve-success-to: #34d399;
                --icve-success-glow: rgba(16, 185, 129, 0.35);
                --icve-warning-from: #f59e0b;
                --icve-warning-to: #fbbf24;
                --icve-warning-glow: rgba(245, 158, 11, 0.35);
                --icve-info-from: #0ea5e9;
                --icve-info-to: #38bdf8;
                --icve-info-glow: rgba(14, 165, 233, 0.35);
                --icve-danger-from: #ef4444;
                --icve-danger-to: #f87171;
                --icve-danger-glow: rgba(239, 68, 68, 0.35);

                /* æµ…è‰²ä¸»é¢˜ */
                --icve-bg-base: #f8fafc;
                --icve-bg-elevated: #ffffff;
                --icve-bg-sunken: #f1f5f9;
                --icve-bg-glass: rgba(255, 255, 255, 0.72);
                --icve-bg-glass-strong: rgba(255, 255, 255, 0.88);
                --icve-border-subtle: rgba(148, 163, 184, 0.2);
                --icve-border-default: rgba(148, 163, 184, 0.35);
                --icve-text-primary: #0f172a;
                --icve-text-secondary: #475569;
                --icve-text-tertiary: #94a3b8;
                --icve-text-inverted: #ffffff;
                --icve-shadow-ambient: 0 8px 32px rgba(15, 23, 42, 0.08);
                --icve-shadow-elevated: 0 24px 48px rgba(15, 23, 42, 0.12);
                --icve-shadow-glow: 0 0 60px rgba(139, 92, 246, 0.15);

                /* åŠ¨ç”» */
                --icve-ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
                --icve-ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
                --icve-duration-fast: 0.2s;
                --icve-duration-normal: 0.35s;
                --icve-duration-slow: 0.5s;
            }

            /* ==================== åŸºç¡€é¢æ¿æ ·å¼ ==================== */
            #icve-tabbed-panel {
                position: fixed;
                top: 24px;
                right: 24px;
                width: 400px;
                max-height: 92vh;
                z-index: 999999;
                font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
                animation: icvePanelEnter 0.7s var(--icve-ease-out-expo);
            }

            @keyframes icvePanelEnter {
                0% {
                    opacity: 0;
                    transform: translateX(80px) scale(0.92) rotateY(-8deg);
                    filter: blur(8px);
                }
                100% {
                    opacity: 1;
                    transform: translateX(0) scale(1) rotateY(0);
                    filter: blur(0);
                }
            }

            .panel-container {
                background: var(--icve-bg-glass);
                backdrop-filter: blur(24px) saturate(180%);
                -webkit-backdrop-filter: blur(24px) saturate(180%);
                border-radius: 24px;
                border: 1px solid var(--icve-border-subtle);
                box-shadow:
                    var(--icve-shadow-elevated),
                    var(--icve-shadow-glow),
                    inset 0 1px 1px rgba(255, 255, 255, 0.6);
                overflow: hidden;
                display: flex;
                flex-direction: column;
                max-height: 92vh;
                transition: all var(--icve-duration-normal) var(--icve-ease-out-expo);
                position: relative;
            }

            /* é¢æ¿å…‰æ™•èƒŒæ™¯ */
            .panel-container::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(
                    ellipse at 30% 20%,
                    rgba(99, 102, 241, 0.08) 0%,
                    transparent 50%
                ),
                radial-gradient(
                    ellipse at 70% 80%,
                    rgba(217, 70, 239, 0.06) 0%,
                    transparent 50%
                );
                pointer-events: none;
                z-index: 0;
            }

            .panel-container:hover {
                box-shadow:
                    0 32px 64px rgba(15, 23, 42, 0.16),
                    0 0 80px rgba(139, 92, 246, 0.2),
                    inset 0 1px 1px rgba(255, 255, 255, 0.6);
                transform: translateY(-2px);
            }

            /* ==================== å¤´éƒ¨æ ·å¼ ==================== */
            .panel-header {
                padding: 18px 20px;
                background: linear-gradient(
                    135deg,
                    var(--icve-primary-from) 0%,
                    var(--icve-primary-via) 50%,
                    var(--icve-primary-to) 100%
                );
                cursor: move;
                display: flex;
                justify-content: space-between;
                align-items: center;
                user-select: none;
                position: relative;
                z-index: 1;
                overflow: hidden;
            }

            /* å¤´éƒ¨åŠ¨æ€å…‰æ•ˆ */
            .panel-header::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.2) 50%,
                    transparent 100%
                );
                animation: headerShine 4s ease-in-out infinite;
            }

            @keyframes headerShine {
                0%, 100% { left: -100%; }
                50% { left: 100%; }
            }

            /* å¤´éƒ¨åº•éƒ¨æ¸å˜é˜´å½± */
            .panel-header::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 1px;
                background: linear-gradient(
                    90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.4) 50%,
                    transparent 100%
                );
            }

            .panel-title {
                font-weight: 700;
                font-size: 16px;
                color: var(--icve-text-inverted);
                text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                letter-spacing: 0.5px;
                position: relative;
                z-index: 1;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .panel-title::before {
                content: '';
                width: 8px;
                height: 8px;
                background: var(--icve-text-inverted);
                border-radius: 50%;
                box-shadow: 0 0 12px rgba(255, 255, 255, 0.6);
                animation: titlePulse 2s ease-in-out infinite;
            }

            @keyframes titlePulse {
                0%, 100% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.6; transform: scale(0.8); }
            }

            .header-controls {
                display: flex;
                gap: 10px;
                position: relative;
                z-index: 1;
            }

            /* å¤´éƒ¨æ§åˆ¶æŒ‰é’®åŠ¨ç”»ä¼˜åŒ– */
            .theme-toggle, .panel-toggle {
                background: rgba(255, 255, 255, 0.18);
                border: 1px solid rgba(255, 255, 255, 0.25);
                color: white;
                width: 36px;
                height: 36px;
                border-radius: 12px;
                cursor: pointer;
                font-size: 16px;
                transition: all var(--icve-duration-normal) var(--icve-ease-spring);
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(8px);
                position: relative;
                overflow: hidden;
            }

            .theme-toggle::before, .panel-toggle::before {
                content: '';
                position: absolute;
                inset: 0;
                background: rgba(255, 255, 255, 0);
                transition: background var(--icve-duration-fast) ease;
            }

            .theme-toggle:hover, .panel-toggle:hover {
                background: rgba(255, 255, 255, 0.28);
                border-color: rgba(255, 255, 255, 0.4);
                transform: scale(1.08) rotate(6deg);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            }

            .theme-toggle:hover::before, .panel-toggle:hover::before {
                background: rgba(255, 255, 255, 0.1);
            }

            .theme-toggle:active, .panel-toggle:active {
                transform: scale(0.96) rotate(0deg);
                transition: transform 0.1s ease;
            }

            /* ==================== æ ‡ç­¾é¡µå¯¼èˆª ==================== */
            .tab-nav {
                display: flex;
                background: var(--icve-bg-sunken);
                padding: 8px 12px 0;
                gap: 4px;
                position: relative;
                z-index: 1;
            }

            .tab-btn {
                flex: 1;
                padding: 14px 16px;
                background: transparent;
                border: none;
                cursor: pointer;
                font-family: 'Outfit', sans-serif;
                font-size: 14px;
                font-weight: 600;
                color: var(--icve-text-tertiary);
                transition: all var(--icve-duration-normal) var(--icve-ease-out-expo);
                position: relative;
                border-radius: 14px 14px 0 0;
                letter-spacing: 0.3px;
            }

            .tab-btn:hover {
                color: var(--icve-primary-via);
                background: rgba(139, 92, 246, 0.08);
            }

            .tab-btn.active {
                color: var(--icve-primary-via);
                background: var(--icve-bg-glass-strong);
                box-shadow: 0 -4px 16px rgba(139, 92, 246, 0.1);
            }

            .tab-btn.active::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 16px;
                right: 16px;
                height: 3px;
                background: linear-gradient(
                    90deg,
                    var(--icve-primary-from),
                    var(--icve-primary-via),
                    var(--icve-primary-to)
                );
                border-radius: 3px 3px 0 0;
                animation: tabIndicator 0.4s var(--icve-ease-spring);
            }

            @keyframes tabIndicator {
                from {
                    transform: scaleX(0);
                    opacity: 0;
                }
                to {
                    transform: scaleX(1);
                    opacity: 1;
                }
            }

            /* ==================== æ ‡ç­¾é¡µå†…å®¹ ==================== */
            .tab-content-wrapper {
                overflow-y: auto;
                max-height: calc(92vh - 140px);
                scrollbar-width: thin;
                scrollbar-color: rgba(139, 92, 246, 0.3) transparent;
                position: relative;
                z-index: 1;
            }

            .tab-content-wrapper::-webkit-scrollbar {
                width: 6px;
            }

            .tab-content-wrapper::-webkit-scrollbar-track {
                background: transparent;
            }

            .tab-content-wrapper::-webkit-scrollbar-thumb {
                background: linear-gradient(
                    180deg,
                    var(--icve-primary-from),
                    var(--icve-primary-to)
                );
                border-radius: 10px;
            }

            .tab-content-wrapper::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(
                    180deg,
                    var(--icve-primary-via),
                    var(--icve-primary-to)
                );
            }

            .tab-content-wrapper.collapsed {
                display: none;
            }

            .tab-nav.collapsed {
                display: none;
            }

            .tab-pane {
                display: none;
                background: var(--icve-bg-glass-strong);
                animation: tabPaneFade 0.5s var(--icve-ease-out-expo);
            }

            @keyframes tabPaneFade {
                from {
                    opacity: 0;
                    transform: translateY(16px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .tab-pane.active {
                display: block;
            }

            .tab-inner {
                padding: 20px;
            }

            /* ==================== çŠ¶æ€å¡ç‰‡ - ç»ç’ƒæ‹Ÿæ€ ==================== */
            /* ==================== å­¦ä¹ é¡µé¢æ ·å¼ ==================== */
            .learning-status-section {
                background: var(--icve-bg-glass);
                backdrop-filter: blur(12px);
                border-radius: 16px;
                padding: 14px 16px;
                margin-bottom: 14px;
                border: 1px solid var(--icve-border-subtle);
            }

            .status-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }

            .status-item {
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 13px;
                font-weight: 600;
                color: var(--icve-text-primary);
            }

            .status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: #94a3b8;
                transition: all 0.3s ease;
            }

            .status-dot.running {
                background: #10b981;
                box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
                animation: pulse 1.5s infinite;
            }

            .status-dot.completed {
                background: #8b5cf6;
            }

            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }

            .learning-controls {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-bottom: 14px;
            }

            .btn-large {
                width: 100%;
                padding: 14px 20px;
                font-size: 15px;
                background: linear-gradient(
                    135deg,
                    var(--icve-success-from) 0%,
                    var(--icve-success-to) 100%
                );
                color: white !important;
                box-shadow: 0 4px 16px var(--icve-success-glow);
            }

            .btn-large:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 6px 24px var(--icve-success-glow);
            }

            .btn-large:disabled {
                background: linear-gradient(135deg, #9ca3af, #6b7280);
                box-shadow: none;
                cursor: not-allowed;
                opacity: 0.7;
            }

            .btn-group {
                display: flex;
                gap: 8px;
            }

            .btn-group .btn {
                flex: 1;
                padding: 10px 12px;
                font-size: 13px;
            }

            .btn-outline {
                background: var(--icve-bg-elevated) !important;
                color: #374151 !important;
                border: 1px solid var(--icve-border-subtle) !important;
            }

            .btn-outline:hover {
                background: var(--icve-bg-glass) !important;
                border-color: var(--icve-primary-from) !important;
            }

            .btn-toggle-label {
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 4px;
                color: #374151 !important;
            }

            .btn-toggle-label:has(input:checked) {
                background: linear-gradient(135deg, var(--icve-primary-from), var(--icve-primary-to)) !important;
                color: white !important;
                border-color: transparent !important;
            }

            .settings-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .status-card-compact {
                background: var(--icve-bg-glass);
                backdrop-filter: blur(12px);
                border-radius: 18px;
                padding: 16px;
                margin-bottom: 16px;
                border: 1px solid var(--icve-border-subtle);
                box-shadow:
                    var(--icve-shadow-ambient),
                    inset 0 1px 0 rgba(255, 255, 255, 0.5);
                transition: all var(--icve-duration-normal) var(--icve-ease-out-expo);
                position: relative;
                overflow: hidden;
            }

            .status-card-compact::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 1px;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(255, 255, 255, 0.8),
                    transparent
                );
            }

            /* çŠ¶æ€å¡ç‰‡hoveræ•ˆæœä¼˜åŒ– */
            .status-card-compact:hover {
                transform: translateY(-2px);
                box-shadow:
                    0 12px 32px rgba(15, 23, 42, 0.1),
                    0 0 32px rgba(139, 92, 246, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.5);
            }

            .status-inline {
                display: flex;
                gap: 10px;
                margin-bottom: 14px;
            }

            .status-badge {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                padding: 10px 12px;
                background: var(--icve-bg-elevated);
                border-radius: 12px;
                border: 1px solid var(--icve-border-subtle);
                transition: all var(--icve-duration-normal) var(--icve-ease-spring);
                cursor: default;
            }

            .status-badge:hover {
                transform: translateY(-1px) scale(1.01);
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
                border-color: var(--icve-primary-via);
            }

            .badge-icon {
                font-size: 16px;
                line-height: 1;
            }

            .badge-value {
                font-size: 14px;
                font-weight: 700;
                color: var(--icve-text-primary);
                font-family: 'JetBrains Mono', monospace;
            }

            /* ==================== è¿›åº¦æ¡ - æ¸å˜å‘å…‰ ==================== */
            .progress-bar-wrapper {
                height: 8px;
                background: var(--icve-bg-sunken);
                border-radius: 10px;
                overflow: visible;
                box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.08);
                margin-bottom: 14px;
                position: relative;
            }

            .progress-bar {
                height: 100%;
                background: linear-gradient(
                    90deg,
                    var(--icve-primary-from),
                    var(--icve-primary-via),
                    var(--icve-primary-to)
                );
                width: 0%;
                transition: width 0.8s var(--icve-ease-out-expo);
                border-radius: 10px;
                position: relative;
                box-shadow:
                    0 0 20px var(--icve-primary-glow),
                    0 0 40px rgba(139, 92, 246, 0.2);
            }

            .progress-bar::before {
                content: attr(data-progress);
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                font-size: 11px;
                font-weight: 700;
                font-family: 'JetBrains Mono', monospace;
                color: var(--icve-primary-via);
                background: var(--icve-bg-elevated);
                padding: 4px 8px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                border: 1px solid var(--icve-border-subtle);
            }

            .progress-bar::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(
                    90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.4) 50%,
                    transparent 100%
                );
                animation: progressShimmer 2s ease-in-out infinite;
            }

            @keyframes progressShimmer {
                0% { transform: translateX(-100%); }
                100% { transform: translateX(100%); }
            }

            .current-node {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px 14px;
                background: var(--icve-bg-elevated);
                border-radius: 10px;
                font-size: 12px;
                border: 1px solid var(--icve-border-subtle);
            }

            .node-icon {
                font-size: 16px;
                line-height: 1;
            }

            .node-text {
                flex: 1;
                color: var(--icve-text-secondary);
                font-weight: 600;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* ==================== æŒ‰é’®ç³»ç»Ÿ ==================== */
            .control-buttons-group {
                margin-bottom: 16px;
            }

            .primary-actions {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                margin-bottom: 12px;
            }

            .btn {
                padding: 12px 16px;
                border: none;
                border-radius: 14px;
                cursor: pointer;
                font-family: 'Outfit', sans-serif;
                font-size: 14px;
                font-weight: 700;
                color: var(--icve-text-inverted);
                transition: all var(--icve-duration-normal) var(--icve-ease-spring);
                position: relative;
                overflow: hidden;
                letter-spacing: 0.3px;
            }

            .btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 50%;
                background: linear-gradient(
                    180deg,
                    rgba(255, 255, 255, 0.2) 0%,
                    transparent 100%
                );
                pointer-events: none;
            }

            .btn::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: translate(-50%, -50%);
                transition: width 0.6s ease, height 0.6s ease;
            }

            .btn:active::after {
                width: 400px;
                height: 400px;
            }

            .btn:disabled {
                opacity: 0.4;
                cursor: not-allowed;
                transform: none !important;
                filter: grayscale(0.3);
            }

            .btn-primary {
                height: 50px;
                font-size: 15px;
            }

            .btn-start {
                background: linear-gradient(
                    135deg,
                    var(--icve-success-from) 0%,
                    var(--icve-success-to) 100%
                );
                box-shadow:
                    0 4px 16px var(--icve-success-glow),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }

            /* æŒ‰é’®hoeræ•ˆæœä¼˜åŒ– */
            .btn-start:hover:not(:disabled) {
                transform: translateY(-2px) scale(1.01);
                box-shadow:
                    0 6px 24px var(--icve-success-glow),
                    0 0 32px rgba(16, 185, 129, 0.18),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }

            .btn-start:active:not(:disabled) {
                transform: translateY(0) scale(0.98);
                transition: transform 0.1s ease;
            }

            .btn-stop {
                background: linear-gradient(
                    135deg,
                    var(--icve-warning-from) 0%,
                    var(--icve-warning-to) 100%
                );
                box-shadow:
                    0 4px 16px var(--icve-warning-glow),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }

            .btn-stop:hover:not(:disabled) {
                transform: translateY(-2px) scale(1.01);
                box-shadow:
                    0 6px 24px var(--icve-warning-glow),
                    0 0 32px rgba(245, 158, 11, 0.18),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }

            .btn-stop:active:not(:disabled) {
                transform: translateY(0) scale(0.98);
                transition: transform 0.1s ease;
            }

            .secondary-actions {
                display: flex;
                gap: 8px;
            }

            .btn-secondary {
                flex: 1;
                height: 40px;
                font-size: 13px;
                font-weight: 600;
                background: linear-gradient(
                    135deg,
                    #64748b 0%,
                    #475569 100%
                );
                box-shadow:
                    0 3px 12px rgba(71, 85, 105, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.15);
            }

            .btn-secondary:hover:not(:disabled) {
                transform: translateY(-1px);
                box-shadow:
                    0 4px 16px rgba(71, 85, 105, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.15);
            }

            .btn-secondary:active:not(:disabled) {
                transform: translateY(0);
                transition: transform 0.1s ease;
            }

            .btn-scan {
                background: linear-gradient(
                    135deg,
                    var(--icve-info-from) 0%,
                    var(--icve-info-to) 100%
                );
                box-shadow:
                    0 3px 12px var(--icve-info-glow),
                    inset 0 1px 0 rgba(255, 255, 255, 0.15);
            }

            .btn-scan:hover:not(:disabled) {
                transform: translateY(-1px);
                box-shadow:
                    0 5px 18px var(--icve-info-glow),
                    inset 0 1px 0 rgba(255, 255, 255, 0.15);
            }

            .btn-reset {
                background: linear-gradient(
                    135deg,
                    var(--icve-primary-via) 0%,
                    var(--icve-primary-to) 100%
                );
                box-shadow:
                    0 3px 12px var(--icve-primary-glow),
                    inset 0 1px 0 rgba(255, 255, 255, 0.15);
            }

            .btn-reset:hover:not(:disabled) {
                transform: translateY(-1px);
                box-shadow:
                    0 5px 18px var(--icve-primary-glow),
                    inset 0 1px 0 rgba(255, 255, 255, 0.15);
            }

            /* é™éŸ³åˆ‡æ¢æŒ‰é’®ä¼˜åŒ– */
            .btn-toggle {
                flex: 1;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                background: var(--icve-bg-elevated);
                border-radius: 12px;
                cursor: pointer;
                transition: all var(--icve-duration-normal) var(--icve-ease-spring);
                font-size: 13px;
                font-weight: 600;
                color: var(--icve-text-secondary);
                border: 2px solid var(--icve-border-default);
                padding: 0 12px;
            }

            .btn-toggle:hover {
                border-color: var(--icve-primary-via);
                color: var(--icve-primary-via);
                box-shadow: 0 3px 12px rgba(139, 92, 246, 0.12);
                transform: translateY(-1px);
            }

            .btn-toggle:active {
                transform: translateY(0);
                transition: transform 0.1s ease;
            }

            .btn-toggle input[type="checkbox"] {
                display: none;
            }

            .toggle-icon {
                font-size: 16px;
                transition: transform var(--icve-duration-normal) var(--icve-ease-spring);
            }

            .btn-toggle:hover .toggle-icon {
                transform: scale(1.2);
            }

            .toggle-text {
                font-size: 13px;
            }

            /* ==================== è®¾ç½®åŒºåŸŸ ==================== */
            .settings-section {
                margin-bottom: 16px;
                padding: 16px;
                border-radius: 16px;
                background: var(--icve-bg-glass);
                backdrop-filter: blur(8px);
                border: 1px solid var(--icve-border-subtle);
                transition: all var(--icve-duration-normal) var(--icve-ease-out-expo);
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }

            .settings-section:hover {
                box-shadow:
                    0 8px 24px rgba(0, 0, 0, 0.06),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
                border-color: var(--icve-border-default);
            }

            .settings-section:last-child {
                margin-bottom: 0;
            }

            .section-header h3 {
                margin: 0 0 12px 0;
                font-size: 14px;
                font-weight: 700;
                color: var(--icve-text-primary);
                letter-spacing: 0.3px;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .settings-grid-compact {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 14px;
            }

            .setting-item {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .setting-label {
                font-size: 12px;
                font-weight: 600;
                color: var(--icve-text-tertiary);
                letter-spacing: 0.3px;
                text-transform: uppercase;
            }

            .input-with-unit {
                display: flex;
                align-items: center;
                background: var(--icve-bg-elevated);
                border-radius: 10px;
                padding: 4px 4px 4px 12px;
                border: 2px solid var(--icve-border-default);
                transition: all var(--icve-duration-normal) var(--icve-ease-out-expo);
            }

            .input-with-unit:focus-within {
                border-color: var(--icve-primary-via);
                box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
            }

            .input-with-unit input {
                flex: 1;
                border: none;
                background: transparent;
                padding: 8px 4px;
                font-family: 'JetBrains Mono', monospace;
                font-size: 14px;
                font-weight: 600;
                color: var(--icve-text-primary);
                outline: none;
            }

            .input-with-unit .unit {
                font-size: 12px;
                font-weight: 600;
                color: var(--icve-text-tertiary);
                padding: 0 10px;
                white-space: nowrap;
            }

            .select-control, .input-control {
                width: 100%;
                padding: 10px 12px;
                border: 2px solid var(--icve-border-default);
                border-radius: 10px;
                background: var(--icve-bg-elevated);
                color: var(--icve-text-primary);
                font-family: 'Outfit', sans-serif;
                font-size: 14px;
                font-weight: 500;
                outline: none;
                transition: all var(--icve-duration-normal) var(--icve-ease-out-expo);
                cursor: pointer;
            }

            .select-control:hover, .input-control:hover {
                border-color: var(--icve-border-default);
                background: var(--icve-bg-sunken);
            }

            .select-control:focus, .input-control:focus {
                border-color: var(--icve-primary-via);
                background: var(--icve-bg-elevated);
                box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
            }

            /* ==================== ç­”é¢˜é¡µé…ç½® ==================== */
            .quick-config {
                display: flex;
                gap: 10px;
                margin-bottom: 16px;
                padding: 14px;
                background: var(--icve-bg-glass);
                backdrop-filter: blur(8px);
                border-radius: 14px;
                border: 1px solid var(--icve-border-subtle);
            }

            .config-item {
                flex: 1;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .config-item.config-ai {
                flex: 1.6;
                min-width: 0;
            }

            .config-item.config-delay {
                flex: 1.4;
                min-width: 0;
            }

            .config-item.config-submit {
                flex: 1;
                min-width: 0;
            }

            .config-label {
                font-size: 18px;
                line-height: 1;
            }

            .select-compact, .input-compact {
                flex: 1;
                min-width: 0;
                height: 36px;
                padding: 6px 10px;
                font-size: 13px;
                border-radius: 8px;
            }

            .config-ai .select-compact {
                font-weight: 700;
                color: var(--icve-primary-via);
            }

            .config-delay .input-compact {
                text-align: center;
                font-weight: 600;
                font-family: 'JetBrains Mono', monospace;
            }

            .input-with-unit-inline {
                flex: 1;
                display: flex;
                align-items: center;
                gap: 4px;
                background: var(--icve-bg-elevated);
                border-radius: 8px;
                padding: 4px 8px;
                border: 2px solid var(--icve-border-default);
            }

            .input-with-unit-inline input {
                flex: 1;
                border: none;
                background: transparent;
                padding: 4px;
                font-family: 'JetBrains Mono', monospace;
                font-size: 13px;
                font-weight: 600;
                outline: none;
                color: var(--icve-text-primary);
            }

            .input-with-unit-inline .unit {
                font-size: 11px;
                color: var(--icve-text-tertiary);
                font-weight: 600;
            }

            .switch-item-inline {
                display: flex;
                align-items: center;
                gap: 6px;
                cursor: pointer;
            }

            .switch-item-inline input[type="checkbox"] {
                width: 18px;
                height: 18px;
                cursor: pointer;
                accent-color: var(--icve-primary-via);
            }

            .switch-label-inline {
                font-size: 13px;
                font-weight: 600;
                color: var(--icve-text-secondary);
                cursor: pointer;
                white-space: nowrap;
            }

            /* ==================== API å¯†é’¥åŒºåŸŸ ==================== */
            .api-key-section {
                margin-bottom: 16px;
                padding: 16px;
                background: var(--icve-bg-glass);
                backdrop-filter: blur(8px);
                border-radius: 14px;
                border: 1px solid var(--icve-border-subtle);
            }

            .api-key-header {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 12px;
            }

            .api-icon {
                font-size: 18px;
                line-height: 1;
            }

            .api-label {
                font-size: 14px;
                font-weight: 700;
                color: var(--icve-text-primary);
            }

            .api-hint {
                margin-left: auto;
                font-size: 11px;
                color: var(--icve-text-tertiary);
            }

            .input-api-key {
                width: 100%;
                padding: 12px 14px;
                font-size: 14px;
                font-family: 'JetBrains Mono', monospace;
                font-weight: 500;
                background: var(--icve-bg-elevated);
                border: 2px solid var(--icve-border-default);
                border-radius: 10px;
                transition: all var(--icve-duration-normal) var(--icve-ease-out-expo);
                color: var(--icve-text-primary);
            }

            .input-api-key:focus {
                border-color: var(--icve-primary-via);
                box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.12);
                outline: none;
            }

            .input-api-key::placeholder {
                color: var(--icve-text-tertiary);
            }

            /* ==================== çŠ¶æ€æ¶ˆæ¯ ==================== */
            .status-message {
                padding: 12px 16px;
                background: var(--icve-bg-glass);
                backdrop-filter: blur(8px);
                border-radius: 12px;
                font-size: 13px;
                color: var(--icve-text-secondary);
                text-align: center;
                margin-bottom: 12px;
                border: 1px solid var(--icve-border-subtle);
                transition: all var(--icve-duration-normal) var(--icve-ease-out-expo);
                font-weight: 500;
            }

            .status-message:hover {
                border-color: var(--icve-border-default);
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
            }

            /* ==================== é«˜çº§è®¾ç½® ==================== */
            .advanced-settings {
                margin: 12px 0;
                border: 2px solid var(--icve-border-default);
                border-radius: 12px;
                overflow: hidden;
                transition: all var(--icve-duration-normal) var(--icve-ease-out-expo);
            }

            .advanced-settings:hover {
                border-color: var(--icve-border-default);
            }

            .advanced-settings[open] {
                border-color: var(--icve-primary-via);
            }

            .advanced-settings summary {
                padding: 12px 16px;
                background: var(--icve-bg-sunken);
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                color: var(--icve-text-secondary);
                user-select: none;
                transition: all var(--icve-duration-normal) var(--icve-ease-out-expo);
                list-style: none;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .advanced-settings summary::-webkit-details-marker {
                display: none;
            }

            .advanced-settings summary::after {
                content: 'â–¸';
                margin-left: auto;
                transition: transform var(--icve-duration-normal) var(--icve-ease-out-expo);
            }

            .advanced-settings[open] summary::after {
                transform: rotate(90deg);
            }

            .advanced-settings summary:hover {
                background: var(--icve-bg-elevated);
                color: var(--icve-primary-via);
            }

            .advanced-content {
                padding: 16px;
                display: flex;
                flex-direction: column;
                gap: 12px;
                background: var(--icve-bg-glass);
                animation: advancedSlide 0.4s var(--icve-ease-out-expo);
            }

            @keyframes advancedSlide {
                from {
                    opacity: 0;
                    transform: translateY(-8px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .advanced-item {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .advanced-item label {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 13px;
                font-weight: 600;
                color: var(--icve-text-secondary);
            }

            .label-icon {
                font-size: 16px;
                line-height: 1;
            }

            .hint {
                font-size: 11px;
                color: var(--icve-text-tertiary);
                margin-top: 4px;
                font-weight: 500;
                letter-spacing: 0.2px;
            }

            /* ==================== æ·±è‰²ä¸»é¢˜ ==================== */
            #icve-tabbed-panel.dark-theme {
                --icve-bg-base: #0f172a;
                --icve-bg-elevated: #1e293b;
                --icve-bg-sunken: #0c1322;
                --icve-bg-glass: rgba(30, 41, 59, 0.8);
                --icve-bg-glass-strong: rgba(30, 41, 59, 0.92);
                --icve-border-subtle: rgba(148, 163, 184, 0.12);
                --icve-border-default: rgba(148, 163, 184, 0.2);
                --icve-text-primary: #f1f5f9;
                --icve-text-secondary: #94a3b8;
                --icve-text-tertiary: #64748b;
                --icve-shadow-ambient: 0 8px 32px rgba(0, 0, 0, 0.3);
                --icve-shadow-elevated: 0 24px 48px rgba(0, 0, 0, 0.4);
                --icve-shadow-glow: 0 0 60px rgba(139, 92, 246, 0.25);
            }

            #icve-tabbed-panel.dark-theme .panel-container {
                box-shadow:
                    var(--icve-shadow-elevated),
                    var(--icve-shadow-glow),
                    inset 0 1px 1px rgba(255, 255, 255, 0.08);
            }

            #icve-tabbed-panel.dark-theme .panel-container::before {
                background: radial-gradient(
                    ellipse at 30% 20%,
                    rgba(99, 102, 241, 0.15) 0%,
                    transparent 50%
                ),
                radial-gradient(
                    ellipse at 70% 80%,
                    rgba(217, 70, 239, 0.12) 0%,
                    transparent 50%
                );
            }

            #icve-tabbed-panel.dark-theme .panel-container:hover {
                box-shadow:
                    0 32px 64px rgba(0, 0, 0, 0.5),
                    0 0 80px rgba(139, 92, 246, 0.3),
                    inset 0 1px 1px rgba(255, 255, 255, 0.08);
            }

            #icve-tabbed-panel.dark-theme .status-card-compact::before {
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(255, 255, 255, 0.15),
                    transparent
                );
            }

            #icve-tabbed-panel.dark-theme .status-badge {
                background: var(--icve-bg-base);
            }

            #icve-tabbed-panel.dark-theme .progress-bar::before {
                background: var(--icve-bg-base);
            }

            #icve-tabbed-panel.dark-theme .tab-content-wrapper::-webkit-scrollbar-thumb {
                background: linear-gradient(
                    180deg,
                    rgba(99, 102, 241, 0.6),
                    rgba(217, 70, 239, 0.6)
                );
            }

            #icve-tabbed-panel.dark-theme .settings-section {
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
            }

            #icve-tabbed-panel.dark-theme .btn-toggle {
                background: var(--icve-bg-base);
            }

            #icve-tabbed-panel.dark-theme .input-with-unit {
                background: var(--icve-bg-base);
            }

            #icve-tabbed-panel.dark-theme .input-with-unit-inline {
                background: var(--icve-bg-base);
            }

            #icve-tabbed-panel.dark-theme .input-api-key {
                background: var(--icve-bg-base);
            }

            #icve-tabbed-panel.dark-theme .select-control,
            #icve-tabbed-panel.dark-theme .input-control {
                background: var(--icve-bg-base);
            }

            #icve-tabbed-panel.dark-theme .select-control:hover,
            #icve-tabbed-panel.dark-theme .input-control:hover {
                background: var(--icve-bg-elevated);
            }

            #icve-tabbed-panel.dark-theme .select-control:focus,
            #icve-tabbed-panel.dark-theme .input-control:focus {
                background: var(--icve-bg-base);
            }

            #icve-tabbed-panel.dark-theme .advanced-settings summary {
                background: var(--icve-bg-base);
            }

            #icve-tabbed-panel.dark-theme .advanced-settings summary:hover {
                background: var(--icve-bg-elevated);
            }

            /* ==================== å…¼å®¹æ—§æ ·å¼ ==================== */
            .status-card {
                background: var(--icve-bg-glass);
                backdrop-filter: blur(12px);
                border-radius: 18px;
                padding: 16px;
                margin-bottom: 16px;
                border: 1px solid var(--icve-border-subtle);
                box-shadow: var(--icve-shadow-ambient);
            }

            .status-row {
                display: flex;
                gap: 10px;
                margin-bottom: 8px;
            }

            .status-row:last-child {
                margin-bottom: 0;
            }

            .status-item {
                flex: 1;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 12px;
                padding: 8px 12px;
                background: var(--icve-bg-elevated);
                border-radius: 10px;
            }

            .label {
                color: var(--icve-text-tertiary);
                font-weight: 600;
            }

            .value {
                font-weight: 700;
                font-size: 14px;
                color: var(--icve-text-primary);
                font-family: 'JetBrains Mono', monospace;
            }

            .value.short {
                max-width: 130px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .control-buttons {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 16px;
            }

            .progress-section {
                background: var(--icve-bg-glass);
                backdrop-filter: blur(12px);
                border-radius: 16px;
                padding: 16px;
                border: 1px solid var(--icve-border-subtle);
            }

            .progress-label {
                display: flex;
                align-items: center;
                gap: 6px;
                margin-bottom: 10px;
                font-size: 13px;
                color: var(--icve-text-secondary);
                font-weight: 600;
            }

            .progress-icon {
                font-size: 16px;
                line-height: 1;
            }

            .switches {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            /* ==================== é¡µé¢æ—¥å¿—æ ·å¼ ==================== */
            .log-tab-container {
                display: flex;
                flex-direction: column;
                height: 100%;
                max-height: calc(92vh - 140px);
            }

            .log-container {
                flex: 1;
                overflow-y: auto;
                padding: 12px;
                background: var(--icve-bg-elevated);
                font-family: 'JetBrains Mono', monospace;
                font-size: 12px;
                scrollbar-width: thin;
                scrollbar-color: rgba(139, 92, 246, 0.3) transparent;
                min-height: 280px;
            }

            .log-container::-webkit-scrollbar {
                width: 6px;
            }

            .log-container::-webkit-scrollbar-track {
                background: transparent;
            }

            .log-container::-webkit-scrollbar-thumb {
                background: linear-gradient(
                    180deg,
                    var(--icve-primary-from),
                    var(--icve-primary-to)
                );
                border-radius: 3px;
            }

            .log-footer {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 16px;
                background: var(--icve-bg-glass);
                border-top: 1px solid var(--icve-border-subtle);
            }

            .log-count-text {
                font-size: 13px;
                font-weight: 600;
                color: var(--icve-text-secondary);
            }

            .btn-clear-log {
                height: 34px;
                padding: 0 16px;
                font-size: 13px;
            }

            .log-entry {
                display: flex;
                align-items: flex-start;
                gap: 8px;
                padding: 8px 0;
                border-bottom: 1px solid var(--icve-border-subtle);
                animation: logEntryEnter 0.3s ease-out;
            }

            @keyframes logEntryEnter {
                from {
                    opacity: 0;
                    transform: translateX(20px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            .log-entry:last-child {
                border-bottom: none;
            }

            .log-time {
                color: var(--icve-text-tertiary);
                font-weight: 500;
                min-width: 70px;
            }

            .log-icon {
                font-size: 14px;
                line-height: 1;
            }

            .log-message {
                flex: 1;
                color: var(--icve-text-primary);
                word-break: break-word;
                line-height: 1.4;
            }

            .log-info .log-icon { color: var(--icve-info-from); }
            .log-success .log-icon { color: var(--icve-success-from); }
            .log-warn .log-icon { color: var(--icve-warning-from); }
            .log-error .log-icon { color: var(--icve-danger-from); }

            .log-info .log-message { color: var(--icve-text-primary); }
            .log-success .log-message { color: var(--icve-success-from); }
            .log-warn .log-message { color: var(--icve-warning-from); }
            .log-error .log-message { color: var(--icve-danger-from); font-weight: 600; }

            .log-placeholder {
                text-align: center;
                color: var(--icve-text-tertiary);
                padding: 40px 20px;
                font-style: italic;
            }

            .switch-item {
                display: flex;
                align-items: center;
                padding: 12px 14px;
                background: var(--icve-bg-elevated);
                border: 2px solid var(--icve-border-default);
                border-radius: 12px;
                cursor: pointer;
                transition: all var(--icve-duration-normal) var(--icve-ease-spring);
            }

            .switch-item:hover {
                border-color: var(--icve-primary-via);
                transform: translateX(4px);
                box-shadow: 0 4px 16px rgba(139, 92, 246, 0.15);
            }

            .switch-item input[type="checkbox"] {
                margin-right: 10px;
                width: 18px;
                height: 18px;
                cursor: pointer;
                accent-color: var(--icve-primary-via);
            }

            .switch-label {
                font-size: 14px;
                font-weight: 600;
                color: var(--icve-text-primary);
            }

            .settings-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .setting-row, .setting-row-full {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .setting-row-full {
                grid-column: span 2;
            }

            .setting-row label, .setting-row-full label {
                font-size: 12px;
                font-weight: 600;
                color: var(--icve-text-tertiary);
                text-transform: uppercase;
                letter-spacing: 0.3px;
            }

            .hint-info {
                color: var(--icve-info-from);
            }

            .hint-box {
                padding: 12px 14px;
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                border: 2px solid #fcd34d;
                border-radius: 12px;
                font-size: 13px;
                color: #92400e;
                margin-top: 8px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(252, 211, 77, 0.25);
            }

            .ai-model-selector,
            .api-key-input,
            .exam-delay-setting {
                margin-bottom: 12px;
            }

            .model-label {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 13px;
                font-weight: 600;
                color: var(--icve-text-primary);
                margin-bottom: 8px;
            }

            .select-large, .input-large {
                font-size: 14px;
                padding: 12px 14px;
            }

            .select-large {
                font-weight: 600;
                color: var(--icve-primary-via);
            }

            .input-large {
                font-family: 'JetBrains Mono', monospace;
            }

            .input-with-suffix {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .input-with-suffix .input-control {
                flex: 1;
                min-width: 0;
            }

            .input-suffix {
                font-size: 13px;
                font-weight: 600;
                color: var(--icve-text-tertiary);
                white-space: nowrap;
            }

            .question-bank-stats {
                margin-top: 16px;
                padding: 14px 16px;
                background: var(--icve-bg-glass);
                border-radius: 12px;
                border: 1px solid var(--icve-border-subtle);
            }

            .stats-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 6px 0;
                font-size: 13px;
            }

            .stats-label {
                color: var(--icve-text-secondary);
                font-weight: 600;
            }

            .stats-value {
                color: var(--icve-primary-via);
                font-weight: 700;
                font-size: 14px;
                font-family: 'JetBrains Mono', monospace;
            }
        `;
        document.head.appendChild(style);
    }

    // ==================== äº‹ä»¶ç»‘å®šï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ä¼˜åŒ–ï¼‰ ====================
    function bindEvents() {
        const panel = document.getElementById('icve-tabbed-panel');
        if (!panel) return;

        // æ‹–åŠ¨é¢æ¿
        makeDraggable();

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†é¢æ¿å†…çš„æ‰€æœ‰ç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨é˜²æŠ–ä¼˜åŒ–ï¼‰
        panel.addEventListener('click', Utils.debounce(handlePanelClick, 100));

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ‰€æœ‰changeäº‹ä»¶ï¼ˆä½¿ç”¨èŠ‚æµä¼˜åŒ–ï¼‰
        panel.addEventListener('change', Utils.throttle(handlePanelChange, 300));

        Logger.info('äº‹ä»¶ç»‘å®šå®Œæˆ');
    }

    // ç»Ÿä¸€å¤„ç†ç‚¹å‡»äº‹ä»¶
    function handlePanelClick(e) {
        const target = e.target;
        const id = target.id || target.closest('[id]')?.id;

        // ä½¿ç”¨å¯¹è±¡æ˜ å°„æå‡æ€§èƒ½
        const actionMap = {
            'theme-toggle': toggleTheme,
            'panel-toggle': togglePanel,
            'learning-start': startLearning,
            'learning-scan': scanLearningNodes,
            'learning-reset': resetLearning,
            'exam-start': startExam,
            'exam-stop': stopExam,
            'clear-page-log': () => Logger.clearPageLog()
        };

        // æ‰§è¡Œå¯¹åº”æ“ä½œ
        if (actionMap[id]) {
            actionMap[id]();
            return;
        }

        // å¤„ç†æ ‡ç­¾é¡µåˆ‡æ¢
        const tabBtn = target.closest('.tab-btn');
        if (tabBtn?.dataset.tab) {
            switchTab(tabBtn.dataset.tab);
        }
    }

    // ç»Ÿä¸€å¤„ç†changeäº‹ä»¶
    function handlePanelChange(e) {
        const target = e.target;
        const id = target.id;
        const value = target.type === 'checkbox' ? target.checked : target.value;

        switch(id) {
            // å­¦ä¹ é…ç½®
            case 'learning-playback-rate':
                CONFIG.learning.playbackRate = parseFloat(value);
                applyPlaybackRate();
                saveConfig();
                Logger.info(`æ’­æ”¾å€é€Ÿ: ${CONFIG.learning.playbackRate}x`);
                break;

            case 'learning-wait-time':
                CONFIG.learning.waitTimeAfterComplete = parseInt(value);
                saveConfig();
                Logger.info(`å®Œæˆç­‰å¾…æ—¶é—´: ${value}ç§’`);
                break;

            case 'learning-doc-interval':
                CONFIG.learning.documentPageInterval = parseInt(value);
                saveConfig();
                Logger.info(`æ–‡æ¡£ç¿»é¡µé—´éš”: ${value}ç§’`);
                break;

            case 'learning-expand-delay':
                CONFIG.learning.expandDelay = parseFloat(value);
                saveConfig();
                Logger.info(`å±•å¼€å»¶è¿Ÿ: ${value}ç§’`);
                break;

            case 'learning-mute-media':
                CONFIG.learning.muteMedia = value;
                applyMuteToCurrentMedia();
                saveConfig();
                // æ›´æ–°é™éŸ³æŒ‰é’®å›¾æ ‡
                const toggleIcon = document.querySelector('.btn-toggle-label .toggle-icon');
                if (toggleIcon) {
                    toggleIcon.textContent = value ? 'ğŸ”‡' : 'ğŸ”Š';
                }
                Logger.info(`é™éŸ³æ¨¡å¼: ${value ? 'å¼€å¯' : 'å…³é—­'}`);
                break;

            // ç­”é¢˜é…ç½®
            case 'exam-ai-model':
                CONFIG.exam.currentAI = value;
                const preset = AI_PRESETS[CONFIG.exam.currentAI];
                const aiConfig = getAIConfig();

                // æ›´æ–°è¾“å…¥æ¡†
                const apiKeyInput = document.getElementById('exam-api-key');
                const apiUrlInput = document.getElementById('exam-api-url');
                const modelInput = document.getElementById('exam-api-model-name');

                if (apiKeyInput) {
                    apiKeyInput.value = aiConfig.apiKey;
                    apiKeyInput.placeholder = preset.keyPlaceholder;
                }
                if (apiUrlInput) apiUrlInput.value = aiConfig.baseURL;
                if (modelInput) modelInput.value = aiConfig.model;

                updateExamMessage(`å·²åˆ‡æ¢åˆ° ${preset.name}`, '#10b981');
                setTimeout(() => {
                    updateExamMessage(`å°±ç»ªï¼ˆä½¿ç”¨ ${preset.name}ï¼‰`, '#64748b');
                }, 2000);
                saveConfig();
                Logger.info(`AIæ¨¡å‹: ${preset.name}`);
                break;

            case 'exam-api-key':
                GM_setValue(`ai_key_${CONFIG.exam.currentAI}`, value.trim());
                updateExamMessage('API Keyå·²ä¿å­˜', '#10b981');
                setTimeout(() => {
                    updateExamMessage(`å°±ç»ªï¼ˆä½¿ç”¨ ${AI_PRESETS[CONFIG.exam.currentAI].name}ï¼‰`, '#64748b');
                }, 2000);
                Logger.info('API Keyå·²æ›´æ–°');
                break;

            case 'exam-api-url':
                GM_setValue(`ai_baseurl_${CONFIG.exam.currentAI}`, value.trim());
                updateExamMessage('APIåœ°å€å·²ä¿å­˜', '#10b981');
                setTimeout(() => {
                    updateExamMessage(`å°±ç»ªï¼ˆä½¿ç”¨ ${AI_PRESETS[CONFIG.exam.currentAI].name}ï¼‰`, '#64748b');
                }, 2000);
                Logger.info(`APIåœ°å€å·²æ›´æ–°`);
                break;

            case 'exam-api-model-name':
                GM_setValue(`ai_model_${CONFIG.exam.currentAI}`, value.trim());
                updateExamMessage('æ¨¡å‹åç§°å·²ä¿å­˜', '#10b981');
                setTimeout(() => {
                    updateExamMessage(`å°±ç»ªï¼ˆä½¿ç”¨ ${AI_PRESETS[CONFIG.exam.currentAI].name}ï¼‰`, '#64748b');
                }, 2000);
                Logger.info(`æ¨¡å‹åç§°: ${value.trim()}`);
                break;

            case 'exam-delay':
                CONFIG.exam.delay = parseInt(value) * 1000;
                saveConfig();
                Logger.info(`ç­”é¢˜é—´éš”: ${value}ç§’`);
                break;

            case 'exam-auto-submit':
                CONFIG.exam.autoSubmit = value;
                saveConfig();
                Logger.info(`è‡ªåŠ¨äº¤å·: ${value ? 'å¼€å¯' : 'å…³é—­'}`);
                break;
        }
    }

    // ==================== å·¥å…·å‡½æ•° ====================

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
        // æ›´æ–°å¯¼èˆªæŒ‰é’®
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');

        // æ›´æ–°å†…å®¹åŒºåŸŸ
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active');
        });
        document.getElementById(`tab-${tabName}`)?.classList.add('active');

        // ä¿å­˜å½“å‰æ ‡ç­¾é¡µ
        CONFIG.currentTab = tabName;
        saveConfig();
    }

    // åˆ‡æ¢ä¸»é¢˜
    function toggleTheme() {
        CONFIG.theme = CONFIG.theme === 'light' ? 'dark' : 'light';
        applyTheme(CONFIG.theme);
        saveConfig();
    }

    // åº”ç”¨ä¸»é¢˜
    function applyTheme(theme) {
        const panel = document.getElementById('icve-tabbed-panel');
        const themeBtn = document.getElementById('theme-toggle');

        if (panel) {
            if (theme === 'dark') {
                panel.classList.add('dark-theme');
            } else {
                panel.classList.remove('dark-theme');
            }
        }

        if (themeBtn) {
            themeBtn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            themeBtn.title = theme === 'dark' ? 'åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼';
        }
    }

    // æŠ˜å /å±•å¼€é¢æ¿
    function togglePanel() {
        const wrapper = document.getElementById('tab-content-wrapper');
        const tabNav = document.querySelector('.tab-nav');
        const toggleBtn = document.getElementById('panel-toggle');

        if (wrapper.classList.contains('collapsed')) {
            wrapper.classList.remove('collapsed');
            if (tabNav) tabNav.classList.remove('collapsed');
            toggleBtn.textContent = 'âˆ’';
            localStorage.setItem('icve_panel_collapsed', 'false');
        } else {
            wrapper.classList.add('collapsed');
            if (tabNav) tabNav.classList.add('collapsed');
            toggleBtn.textContent = '+';
            localStorage.setItem('icve_panel_collapsed', 'true');
        }
    }

    // æ¢å¤æŠ˜å çŠ¶æ€
    function restorePanelState() {
        const isCollapsed = localStorage.getItem('icve_panel_collapsed') === 'true';
        if (isCollapsed) {
            const wrapper = document.getElementById('tab-content-wrapper');
            const tabNav = document.querySelector('.tab-nav');
            const toggleBtn = document.getElementById('panel-toggle');

            if (wrapper) wrapper.classList.add('collapsed');
            if (tabNav) tabNav.classList.add('collapsed');
            if (toggleBtn) toggleBtn.textContent = '+';
        }
    }

    // ä½¿é¢æ¿å¯æ‹–åŠ¨
    function makeDraggable() {
        const panel = document.getElementById('icve-tabbed-panel');
        const header = document.getElementById('panel-header');
        let isDragging = false;
        let currentX, currentY, initialX, initialY;

        header.addEventListener('mousedown', (e) => {
            initialX = e.clientX - panel.offsetLeft;
            initialY = e.clientY - panel.offsetTop;
            isDragging = true;
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                panel.style.left = currentX + 'px';
                panel.style.top = currentY + 'px';
                panel.style.right = 'auto';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
    }

    // ==================== ç« èŠ‚ç®¡ç†åŠŸèƒ½ ====================

    // é€šè¿‡APIè·å–ç« èŠ‚å†…å®¹
    async function fetchChapterContentByAPI(chapterId) {
        try {
            // ä»URLä¸­æå–courseInfoIdå’ŒcourseId
            const urlParams = new URLSearchParams(window.location.search);
            const courseInfoId = urlParams.get('courseInfoId');
            const courseId = urlParams.get('courseId');

            if (!courseInfoId || !courseId) {
                return null;
            }

            const apiUrl = `https://ai.icve.com.cn/prod-api/course/courseDesign/getCellList?courseInfoId=${courseInfoId}&courseId=${courseId}&parentId=${chapterId}`;

            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json, text/plain, */*',
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (!response.ok) {
                return null;
            }

            const data = await response.json();
            return data;

        } catch (error) {
            return null;
        }
    }

    // æŸ¥æ‰¾å¹¶å±•å¼€ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„ç« èŠ‚ï¼ˆä½¿ç”¨APIï¼‰
    async function expandNextUncompletedSection() {
        updateLearningProgressText('ğŸ” æ­£åœ¨æŸ¥æ‰¾ä¸‹ä¸€ä¸ªç« èŠ‚...');

        // æŸ¥æ‰¾æ‰€æœ‰ä¸€çº§ç« èŠ‚ï¼ˆ.one ä¸‹çš„ collapse-panelï¼‰
        const sections = document.querySelectorAll('.one > .draggablebox > span > .collapse-panel');

        for (let section of sections) {
            const panelTitle = section.querySelector('.panel-title');
            const panelContent = section.querySelector('.panel-content');

            if (!panelTitle || !panelContent) continue;

            // å¦‚æœç« èŠ‚æ˜¯å±•å¼€çš„ï¼Œæ£€æŸ¥æ˜¯å¦æ‰€æœ‰å­èŠ‚ç‚¹éƒ½å®Œæˆäº†
            if (panelContent.style.display !== 'none') {
                const nodes = section.querySelectorAll('.panelList .node');

                if (nodes.length > 0) {
                    const allCompleted = Array.from(nodes).every(node => {
                        const statusIcon = node.querySelector('.jd');
                        const id = node.id;
                        // è€ƒè¯•èŠ‚ç‚¹ä¹Ÿç®—ä½œå·²å®Œæˆ
                        const isExam = isExamNode(node);
                        return (statusIcon && statusIcon.classList.contains('wc')) || state.learning.processedNodes.has(id) || isExam;
                    });

                    if (allCompleted) {
                        // è¿™ä¸ªç« èŠ‚å…¨éƒ¨å®Œæˆäº†ï¼Œæ ‡è®°ä¸ºå·²å®Œæˆï¼ˆä¸æŠ˜å ï¼‰
                        const chapterId = section.id;

                        if (!state.learning.completedChapters) {
                            state.learning.completedChapters = new Set();
                        }
                        state.learning.completedChapters.add(chapterId);
                        saveLearningProgress();

                        // ç»§ç»­æ£€æŸ¥ä¸‹ä¸€ä¸ªç« èŠ‚
                        continue;
                    } else {
                        // è¿™ä¸ªç« èŠ‚æœ‰æœªå®Œæˆçš„èŠ‚ç‚¹ï¼Œä¸éœ€è¦ç»§ç»­æŸ¥æ‰¾
                        return false;
                    }
                }
            }
            // å¦‚æœç« èŠ‚æ˜¯æŠ˜å çš„
            else {
                const chapterId = section.id;

                // æ£€æŸ¥è¿™ä¸ªç« èŠ‚æ˜¯å¦å·²ç»è¢«æ ‡è®°ä¸ºå®Œæˆï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡
                if (state.learning.completedChapters && state.learning.completedChapters.has(chapterId)) {
                    continue;
                }

                // è¿™æ˜¯ç¬¬ä¸€ä¸ªæŠ˜å ä¸”æœªå®Œæˆçš„ç« èŠ‚ï¼Œå°è¯•å±•å¼€å®ƒ
                const titleText = panelTitle.textContent.trim().substring(0, 40);
                updateLearningProgressText(`ğŸ“‚ æ­£åœ¨å±•å¼€æ–°ç« èŠ‚ï¼š${titleText}...`);

                // æ–¹æ³•1: å…ˆé€šè¿‡APIè·å–å†…å®¹ï¼ˆç¡®ä¿å†…å®¹è¢«åŠ è½½ï¼‰
                await fetchChapterContentByAPI(chapterId);
                await new Promise(resolve => setTimeout(resolve, 500));

                // æ–¹æ³•2: ç‚¹å‡»ç®­å¤´å›¾æ ‡å±•å¼€ï¼ˆè§¦å‘Vueçš„å±•å¼€åŠ¨ç”»ï¼‰
                const arrow = panelTitle.querySelector('.jiantou');
                if (arrow) {
                    arrow.click();
                    await new Promise(resolve => setTimeout(resolve, 800));
                }

                // ç­‰å¾…DOMæ›´æ–°
                await new Promise(resolve => setTimeout(resolve, 2000));

                // å¤šæ¬¡æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å‡ºç°
                let nodes = section.querySelectorAll('.panelList .node');
                let retryCount = 0;
                const maxRetries = 5;

                while (nodes.length === 0 && retryCount < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    nodes = section.querySelectorAll('.panelList .node');
                    retryCount++;

                    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œå†æ¬¡ç‚¹å‡»ç®­å¤´
                    if (nodes.length === 0 && retryCount === 2) {
                        const arrow = panelTitle.querySelector('.jiantou');
                        if (arrow) {
                            arrow.click();
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }

                updateLearningProgressText(`âœ… ç« èŠ‚å±•å¼€æˆåŠŸï¼Œå‘ç° ${nodes.length} ä¸ªèŠ‚ç‚¹`);
                Logger.info(`å±•å¼€æ–°ç« èŠ‚: å‘ç°${nodes.length}ä¸ªèŠ‚ç‚¹`);

                if (nodes.length > 0) {
                    // æ‰¾åˆ°äº†æœ‰èŠ‚ç‚¹çš„ç« èŠ‚ï¼Œç«‹å³è¿”å›
                    return true;
                } else {
                    // è¿™ä¸ªç« èŠ‚æ²¡æœ‰èŠ‚ç‚¹ï¼Œæ ‡è®°ä¸ºå·²å®Œæˆï¼Œç»§ç»­æŸ¥æ‰¾ä¸‹ä¸€ä¸ª
                    if (!state.learning.completedChapters) {
                        state.learning.completedChapters = new Set();
                    }
                    state.learning.completedChapters.add(chapterId);
                    saveLearningProgress();
                    continue;
                }
            }
        }

        return false; // æ²¡æœ‰æ‰¾åˆ°æ–°ç« èŠ‚
    }

    // ==================== å­¦ä¹ åŠŸèƒ½å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰ ====================

    function startLearning() {
        if (state.learning.isRunning) return;

        state.learning.isRunning = true;
        document.getElementById('learning-start').disabled = true;
        document.getElementById('learning-status').textContent = 'è¿è¡Œä¸­';
        const statusDot = document.getElementById('learning-status-dot');
        if (statusDot) statusDot.classList.add('running');

        Logger.info('å¼€å§‹è‡ªåŠ¨å­¦ä¹ ');
        scanLearningNodes();

        // å¼€å§‹ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„èŠ‚ç‚¹
        setTimeout(() => {
            goToNextNode();
        }, 1000);
    }

    // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æ˜¯è€ƒè¯•/æµ‹éªŒç±»å‹
    function isExamNode(nodeElement) {
        // æ£€æŸ¥æ˜¯å¦åŒ…å«"å¼€å§‹ç­”é¢˜"æŒ‰é’®
        const examButton = nodeElement.querySelector('.li_action .btn_dt');
        if (examButton) {
            const btnText = examButton.textContent.trim();
            if (btnText.includes('å¼€å§‹ç­”é¢˜') || btnText.includes('ç­”é¢˜') || btnText.includes('è€ƒè¯•') || btnText.includes('æµ‹éªŒ')) {
                return true;
            }
        }
        return false;
    }

    function scanLearningNodes() {
        const nodes = document.querySelectorAll('.panelList .node');
        state.learning.allNodes = [];
        state.learning.completedCount = 0;
        state.learning.examCount = 0;
        state.learning.totalCount = nodes.length;

        nodes.forEach((node, index) => {
            const titleElement = node.querySelector('.title');
            const statusIcon = node.querySelector('.jd');
            const title = titleElement ? titleElement.textContent.trim() : `èŠ‚ç‚¹${index + 1}`;
            const id = node.id;
            const isCompleted = (statusIcon && statusIcon.classList.contains('wc')) || state.learning.processedNodes.has(id);

            // æ£€æŸ¥æ˜¯å¦æ˜¯è€ƒè¯•èŠ‚ç‚¹
            const isExam = isExamNode(node);
            if (isExam) {
                state.learning.examCount++;
            }

            state.learning.allNodes.push({
                element: node,
                id: id,
                title: title,
                isCompleted: isCompleted,
                isExam: isExam,
                index: index
            });

            if (isCompleted) {
                state.learning.completedCount++;
            }
        });

        const uncompletedCount = state.learning.totalCount - state.learning.completedCount;
        Logger.info(`æ‰«æå®Œæˆ: å…±${state.learning.totalCount}ä¸ªèŠ‚ç‚¹, å·²å®Œæˆ${state.learning.completedCount}ä¸ª, å¾…å­¦ä¹ ${uncompletedCount}ä¸ª`);
        if (state.learning.examCount > 0) {
            Logger.info(`å‘ç°${state.learning.examCount}ä¸ªè€ƒè¯•èŠ‚ç‚¹(å°†è‡ªåŠ¨è·³è¿‡)`);
        }

        updateLearningStatus();
    }

    function resetLearning() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²å¤„ç†èŠ‚ç‚¹çš„è®°å½•å—ï¼Ÿ')) {
            state.learning.processedNodes.clear();
            // åŒæ—¶æ¸…ç©ºå·²å®Œæˆç« èŠ‚çš„è®°å½•
            if (state.learning.completedChapters) {
                state.learning.completedChapters.clear();
            }
            // ä¿å­˜æ¸…ç©ºåçš„çŠ¶æ€
            saveLearningProgress();
            scanLearningNodes();
            Logger.warn('å·²é‡ç½®æ‰€æœ‰å­¦ä¹ è¿›åº¦');
        }
    }

    function updateLearningStatus() {
        const progressText = `${state.learning.completedCount}/${state.learning.totalCount}`;
        const progressElement = document.getElementById('learning-progress');

        if (progressElement) {
            // å¦‚æœæœ‰è€ƒè¯•èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºè·³è¿‡æç¤º
            if (state.learning.examCount > 0) {
                progressElement.textContent = progressText;
                progressElement.title = `è·³è¿‡ ${state.learning.examCount} ä¸ªè€ƒè¯•/æµ‹éªŒèŠ‚ç‚¹`;
            } else {
                progressElement.textContent = progressText;
                progressElement.title = '';
            }
        }

        document.getElementById('learning-processed').textContent =
            state.learning.processedNodes.size;

        if (state.learning.currentNode && state.learning.currentNode.title) {
            const shortTitle = state.learning.currentNode.title.length > 18
                ? state.learning.currentNode.title.substring(0, 18) + '...'
                : state.learning.currentNode.title;
            document.getElementById('learning-current').textContent = shortTitle;
            document.getElementById('learning-current').title = state.learning.currentNode.title;
        } else {
            document.getElementById('learning-current').textContent = 'æ— ';
            document.getElementById('learning-current').title = '';
        }
    }

    function applyPlaybackRate() {
        const mediaElements = [
            ...document.querySelectorAll('audio'),
            ...document.querySelectorAll('video')
        ];
        mediaElements.forEach(media => {
            media.playbackRate = CONFIG.learning.playbackRate;
        });
    }

    function applyMuteToCurrentMedia() {
        const mediaElements = [
            ...document.querySelectorAll('audio'),
            ...document.querySelectorAll('video')
        ];
        mediaElements.forEach(media => {
            media.muted = CONFIG.learning.muteMedia;
        });
    }

    // ç‚¹å‡»èŠ‚ç‚¹
    async function clickNode(nodeInfo) {
        state.learning.currentNode = nodeInfo;
        updateLearningStatus();

        // é‡ç½®è¿›åº¦æ¡å¹¶æ›´æ–°æ–‡æœ¬
        const progressBar = document.getElementById('learning-progress-bar');
        if (progressBar) {
            progressBar.style.width = '0%';
        }
        updateLearningProgressText('æ­£åœ¨åŠ è½½å†…å®¹...');

        const shortTitle = nodeInfo.title.length > 25 ? nodeInfo.title.substring(0, 25) + '...' : nodeInfo.title;
        Logger.info(`å¼€å§‹å­¦ä¹ : ${shortTitle}`);

        if (nodeInfo.element) {
            nodeInfo.element.click();

            // ç­‰å¾…é¡µé¢åŠ è½½åæ£€æµ‹å†…å®¹ç±»å‹
            setTimeout(() => {
                detectContentType();
            }, 2000);
        }
    }

    // æ£€æµ‹å†…å®¹ç±»å‹å¹¶å¤„ç†
    function detectContentType() {
        // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯è€ƒè¯•/æµ‹éªŒé¡µé¢
        const examButton = document.querySelector('.li_action .btn_dt, .btn_dt');
        if (examButton) {
            const btnText = examButton.textContent.trim();
            if (btnText.includes('å¼€å§‹ç­”é¢˜') || btnText.includes('ç­”é¢˜') ||
                btnText.includes('è€ƒè¯•') || btnText.includes('æµ‹éªŒ')) {
                updateLearningProgressText('â­ï¸ æ£€æµ‹åˆ°è€ƒè¯•é¡µé¢ï¼Œå·²è·³è¿‡');
                Logger.warn('è·³è¿‡è€ƒè¯•èŠ‚ç‚¹');

                // æ ‡è®°å½“å‰èŠ‚ç‚¹ä¸ºå·²å¤„ç†
                if (state.learning.currentNode && state.learning.currentNode.id) {
                    state.learning.processedNodes.add(state.learning.currentNode.id);
                    saveLearningProgress();
                    updateLearningStatus();
                }

                // ç»§ç»­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
                if (state.learning.isRunning) {
                    setTimeout(() => {
                        goToNextNode();
                    }, 1000);
                }
                return;
            }
        }

        const mediaElements = [
            ...document.querySelectorAll('audio'),
            ...document.querySelectorAll('video')
        ];

        if (mediaElements.length === 0) {
            // æ²¡æœ‰åª’ä½“å…ƒç´ ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æ–‡æ¡£
            updateLearningProgressText('æ£€æµ‹åˆ°æ–‡æ¡£ï¼Œå‡†å¤‡æµè§ˆ...');
            Logger.info('æ£€æµ‹åˆ°æ–‡æ¡£ç±»å‹å†…å®¹');
            state.learning.isDocument = true;
            setTimeout(() => {
                handleDocument();
            }, 1000);
            return;
        }

        // æœ‰åª’ä½“å…ƒç´ ï¼Œæ’­æ”¾åª’ä½“
        state.learning.isDocument = false;
        const mediaType = mediaElements[0].tagName.toLowerCase() === 'video' ? 'è§†é¢‘' : 'éŸ³é¢‘';
        Logger.info(`æ£€æµ‹åˆ°${mediaType}å†…å®¹ï¼Œå¼€å§‹æ’­æ”¾`);
        playMedia(mediaElements);
    }

    // æ’­æ”¾åª’ä½“
    function playMedia(mediaElements) {
        mediaElements.forEach((media, index) => {
            if (media.dataset.processed) return;
            media.dataset.processed = 'true';

            const mediaType = media.tagName.toLowerCase() === 'video' ? 'è§†é¢‘' : 'éŸ³é¢‘';

            // è®¾ç½®æ’­æ”¾å€é€Ÿ
            media.playbackRate = CONFIG.learning.playbackRate;

            // è®¾ç½®é™éŸ³
            media.muted = CONFIG.learning.muteMedia;

            // æ›´æ–°è¿›åº¦æ–‡æœ¬
            updateLearningProgressText(`${mediaType}æ’­æ”¾ä¸­...`);

            // ç›‘å¬æ’­æ”¾è¿›åº¦
            media.addEventListener('timeupdate', () => {
                if (media.duration > 0) {
                    const current = media.currentTime;
                    const total = media.duration;
                    const percentage = (current / total) * 100;

                    // æ›´æ–°è¿›åº¦æ¡
                    const progressBar = document.getElementById('learning-progress-bar');
                    if (progressBar) {
                        progressBar.style.width = `${percentage}%`;
                        progressBar.setAttribute('data-progress', `${Math.round(percentage)}%`);
                    }

                    // æ›´æ–°è¿›åº¦æ–‡æœ¬
                    updateLearningProgressText(`${mediaType}: ${Utils.formatTime(current)} / ${Utils.formatTime(total)}`);
                }
            });

            // ç›‘å¬æ’­æ”¾ç»“æŸ
            media.addEventListener('ended', () => {
                state.learning.mediaWatching = false;

                Logger.success(`${mediaType}æ’­æ”¾å®Œæˆ`);

                // æ ‡è®°å½“å‰èŠ‚ç‚¹ä¸ºå·²å¤„ç†
                if (state.learning.currentNode && state.learning.currentNode.id) {
                    state.learning.processedNodes.add(state.learning.currentNode.id);
                    saveLearningProgress();
                    updateLearningStatus();
                }

                // é‡ç½®è¿›åº¦æ¡
                const progressBar = document.getElementById('learning-progress-bar');
                if (progressBar) {
                    progressBar.style.width = '0%';
                }
                updateLearningProgressText(`${mediaType}å·²å®Œæˆ`);

                if (state.learning.isRunning) {
                    setTimeout(() => {
                        goToNextNode();
                    }, CONFIG.learning.waitTimeAfterComplete * 1000);
                }
            });

            // è‡ªåŠ¨æ’­æ”¾
            state.learning.mediaWatching = true;
            media.play().catch(err => {
                state.learning.mediaWatching = false;
                Logger.error('åª’ä½“æ’­æ”¾å¤±è´¥: ' + err.message);
            });
        });
    }

    // æ£€æµ‹æ–‡æ¡£é¡µç 
    function getDocumentPageInfo() {
        const pageDiv = document.querySelector('.page');
        if (!pageDiv) return null;

        const match = pageDiv.textContent.match(/(\d+)\s*\/\s*(\d+)/);
        if (match) {
            return {
                current: parseInt(match[1]),
                total: parseInt(match[2])
            };
        }
        return null;
    }

    // ç‚¹å‡»ä¸‹ä¸€é¡µ
    function clickNextPage() {
        const buttons = document.querySelectorAll('.page button');
        for (let btn of buttons) {
            const span = btn.querySelector('span');
            if (span && span.textContent.includes('ä¸‹ä¸€é¡µ')) {
                btn.click();
                return true;
            }
        }
        return false;
    }

    // å¤„ç†æ–‡æ¡£ç±»å‹å†…å®¹
    function handleDocument() {
        const pageInfo = getDocumentPageInfo();

        if (pageInfo) {
            state.learning.currentPage = pageInfo.current;
            state.learning.totalPages = pageInfo.total;

            // æ›´æ–°è¿›åº¦æ¡
            const percentage = (pageInfo.current / pageInfo.total) * 100;
            const progressBar = document.getElementById('learning-progress-bar');
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
                progressBar.setAttribute('data-progress', `${Math.round(percentage)}%`);
            }

            // æ›´æ–°è¿›åº¦æ–‡æœ¬
            updateLearningProgressText(`æ–‡æ¡£: ç¬¬ ${pageInfo.current}/${pageInfo.total} é¡µ`);

            if (pageInfo.current < pageInfo.total) {
                // è¿˜æœ‰ä¸‹ä¸€é¡µ
                setTimeout(() => {
                    if (clickNextPage()) {
                        setTimeout(() => {
                            handleDocument();
                        }, 2000);
                    }
                }, CONFIG.learning.documentPageInterval * 1000);
            } else {
                // æ–‡æ¡£å·²ç»çœ‹å®Œ
                updateLearningProgressText('æ–‡æ¡£å·²æµè§ˆå®Œæˆ');
                Logger.success(`æ–‡æ¡£æµè§ˆå®Œæˆ(å…±${pageInfo.total}é¡µ)`);
                state.learning.isDocument = false;

                // é‡ç½®è¿›åº¦æ¡
                setTimeout(() => {
                    const progressBar = document.getElementById('learning-progress-bar');
                    if (progressBar) {
                        progressBar.style.width = '0%';
                    }
                }, 1000);

                // æ ‡è®°å½“å‰èŠ‚ç‚¹ä¸ºå·²å¤„ç†
                if (state.learning.currentNode && state.learning.currentNode.id) {
                    state.learning.processedNodes.add(state.learning.currentNode.id);
                    saveLearningProgress();
                    updateLearningStatus();
                }

                if (state.learning.isRunning) {
                    setTimeout(() => {
                        goToNextNode();
                    }, CONFIG.learning.waitTimeAfterComplete * 1000);
                }
            }
        } else {
            // æ²¡æœ‰åˆ†é¡µä¿¡æ¯ï¼Œå¯èƒ½æ˜¯å•é¡µæ–‡æ¡£
            updateLearningProgressText('å•é¡µæ–‡æ¡£å·²æµè§ˆ');
            Logger.success('å•é¡µæ–‡æ¡£æµè§ˆå®Œæˆ');
            state.learning.isDocument = false;

            // æ ‡è®°å½“å‰èŠ‚ç‚¹ä¸ºå·²å¤„ç†
            if (state.learning.currentNode && state.learning.currentNode.id) {
                state.learning.processedNodes.add(state.learning.currentNode.id);
                saveLearningProgress();
                updateLearningStatus();
            }

            if (state.learning.isRunning) {
                setTimeout(() => {
                    goToNextNode();
                }, CONFIG.learning.waitTimeAfterComplete * 1000);
            }
        }
    }

    // è¿›å…¥ä¸‹ä¸€ä¸ªæœªå®ŒæˆèŠ‚ç‚¹
    async function goToNextNode() {
        // é‡æ–°æ‰«æä»¥è·å–æœ€æ–°çŠ¶æ€
        scanLearningNodes();

        // æ‰¾åˆ°æœªå®Œæˆçš„èŠ‚ç‚¹
        const uncompletedNodes = state.learning.allNodes.filter(n => !n.isCompleted);

        if (uncompletedNodes.length === 0) {
            // å½“å‰å¯è§èŠ‚ç‚¹éƒ½å®Œæˆäº†ï¼Œå°è¯•å±•å¼€ä¸‹ä¸€ä¸ªç« èŠ‚
            updateLearningProgressText('ğŸ¯ å½“å‰ç« èŠ‚å·²å®Œæˆï¼Œæ­£åœ¨æŸ¥æ‰¾ä¸‹ä¸€ç« èŠ‚...');

            const foundNewSection = await expandNextUncompletedSection();

            if (foundNewSection) {
                // æ‰¾åˆ°äº†æ–°ç« èŠ‚ï¼Œé‡æ–°æ‰«æå¹¶ç»§ç»­
                scanLearningNodes();

                // å†æ¬¡æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„èŠ‚ç‚¹
                const newUncompletedNodes = state.learning.allNodes.filter(n => !n.isCompleted);
                if (newUncompletedNodes.length > 0) {
                    const nextNode = newUncompletedNodes[0];

                    // å¦‚æœæ˜¯è€ƒè¯•èŠ‚ç‚¹ï¼Œè·³è¿‡
                    if (nextNode.isExam) {
                        updateLearningProgressText(`â­ï¸ è·³è¿‡è€ƒè¯•èŠ‚ç‚¹ï¼š${nextNode.title.substring(0, 20)}...`);
                        state.learning.processedNodes.add(nextNode.id);
                        saveLearningProgress();
                        updateLearningStatus();
                        setTimeout(() => {
                            goToNextNode();
                        }, 500);
                        return;
                    }

                    setTimeout(() => {
                        clickNode(nextNode);
                    }, 1000);
                } else {
                    // è¿˜æ˜¯æ²¡æœ‰æœªå®Œæˆçš„èŠ‚ç‚¹ï¼Œé€’å½’ç»§ç»­æŸ¥æ‰¾
                    setTimeout(() => {
                        goToNextNode();
                    }, 1000);
                }
            } else {
                // æ²¡æœ‰æ‰¾åˆ°æ–°ç« èŠ‚ï¼ŒçœŸçš„å®Œæˆäº†
                updateLearningProgressText('ğŸ‰ æ‰€æœ‰ç« èŠ‚å·²å®Œæˆï¼');
                Logger.success('æ‰€æœ‰å­¦ä¹ å†…å®¹å·²å®Œæˆï¼');
                state.learning.isRunning = false;
                document.getElementById('learning-start').disabled = false;
                document.getElementById('learning-status').textContent = 'å·²å®Œæˆ';
                const statusDot = document.getElementById('learning-status-dot');
                if (statusDot) {
                    statusDot.classList.remove('running');
                    statusDot.classList.add('completed');
                }
            }
            return;
        }

        // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„èŠ‚ç‚¹
        const nextNode = uncompletedNodes[0];

        // å¦‚æœæ˜¯è€ƒè¯•èŠ‚ç‚¹ï¼Œæ ‡è®°ä¸ºå·²å¤„ç†å¹¶è·³è¿‡
        if (nextNode.isExam) {
            // æ›´æ–°è¿›åº¦æ–‡æœ¬æç¤º
            updateLearningProgressText(`â­ï¸ è·³è¿‡è€ƒè¯•èŠ‚ç‚¹ï¼š${nextNode.title.substring(0, 20)}...`);

            // æ ‡è®°ä¸ºå·²å¤„ç†
            state.learning.processedNodes.add(nextNode.id);
            saveLearningProgress();
            updateLearningStatus();

            // ç«‹å³ç»§ç»­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
            setTimeout(() => {
                goToNextNode();
            }, 500);
            return;
        }

        // ä¸æ˜¯è€ƒè¯•èŠ‚ç‚¹ï¼Œæ­£å¸¸å­¦ä¹ 
        setTimeout(() => {
            clickNode(nextNode);
        }, 1000);
    }

    // æ·»åŠ çŠ¶æ€ç›¸å…³çš„å˜é‡
    state.learning.currentPage = 1;
    state.learning.totalPages = 1;
    state.learning.isDocument = false;
    state.learning.mediaWatching = false;

    // æ›´æ–°å­¦ä¹ è¿›åº¦æ–‡æœ¬
    function updateLearningProgressText(text) {
        const progressText = document.getElementById('learning-progress-text');
        if (progressText) {
            progressText.textContent = text;
        }
    }

    // ==================== ç­”é¢˜åŠŸèƒ½å®ç° ====================

    // è·å–å½“å‰é¢˜ç›®
    function getCurrentQuestion() {
        const questionEl = document.querySelector('.single, .multiple, .judge, .fill, .completion');
        if (!questionEl) return null;

        const typeMap = {
            'single': 'å•é€‰é¢˜',
            'multiple': 'å¤šé€‰é¢˜',
            'judge': 'åˆ¤æ–­é¢˜',
            'fill': 'å¡«ç©ºé¢˜',
            'completion': 'å¡«ç©ºé¢˜'
        };
        let questionType = 'æœªçŸ¥';
        for (const [cls, type] of Object.entries(typeMap)) {
            if (questionEl.classList.contains(cls)) {
                questionType = type;
                break;
            }
        }

        const titleEl = questionEl.querySelector('.single-title-content, .multiple-title-content, .judge-title-content, .fill-title-content, .completion-title-content');
        const questionText = titleEl ? titleEl.textContent.trim() : '';

        const options = [];
        const optionEls = questionEl.querySelectorAll('.ivu-radio-wrapper, .ivu-checkbox-wrapper');
        optionEls.forEach((optionEl, index) => {
            const optionLabel = String.fromCharCode(65 + index);
            const optionTextEl = optionEl.querySelector('span:last-child');
            const optionText = optionTextEl ? optionTextEl.textContent.trim() : '';
            options.push({ label: optionLabel, text: optionText, element: optionEl });
        });

        let fillInputs = [];
        if (questionType === 'å¡«ç©ºé¢˜') {
            fillInputs = Array.from(questionEl.querySelectorAll('input[type="text"], textarea, .ivu-input'));
        }

        return { type: questionType, text: questionText, options: options, fillInputs: fillInputs, element: questionEl };
    }

    // æŸ¥è¯¢ç­”æ¡ˆï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
    async function searchAnswer(question) {
        try {
            const aiConfig = getAIConfig();
            if (!aiConfig.apiKey || aiConfig.apiKey === '') {
                updateExamMessage('è¯·å…ˆé…ç½®API Key', '#ef4444');
                return null;
            }

            updateExamMessage(`ğŸ“¡ æ­£åœ¨ä½¿ç”¨ ${AI_PRESETS[CONFIG.exam.currentAI].name} æŸ¥è¯¢...`, '#2196F3');

            // ä½¿ç”¨é‡è¯•æœºåˆ¶
            const answer = await Utils.retry(
                () => askAI(question),
                2, // æœ€å¤šé‡è¯•2æ¬¡
                1500 // é‡è¯•é—´éš”1.5ç§’
            );

            return answer;
        } catch (error) {
            Logger.error('æŸ¥è¯¢å¤±è´¥:', error.message);
            updateExamMessage('âŒ æŸ¥è¯¢å¤±è´¥: ' + error.message, '#ef4444');
            return null;
        }
    }

    // è°ƒç”¨AIæ¥å£ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    function askAI(question) {
        return new Promise((resolve, reject) => {
            const aiConfig = getAIConfig();
            const prompt = buildPrompt(question);

            Logger.info(`æ­£åœ¨è¯·æ±‚AI...`);

            const requestBody = {
                model: aiConfig.model,
                messages: [
                    {
                        role: "system",
                        content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç­”é¢˜åŠ©æ‰‹ã€‚ä½ éœ€è¦æ ¹æ®é¢˜ç›®å†…å®¹ï¼Œç»™å‡ºå‡†ç¡®çš„ç­”æ¡ˆã€‚è¯·ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„æ ¼å¼è¿”å›ç­”æ¡ˆã€‚"
                    },
                    { role: "user", content: prompt }
                ],
                temperature: 0.1,
                max_tokens: 500
            };

            const timeoutId = setTimeout(() => {
                reject(new Error('è¯·æ±‚è¶…æ—¶ï¼ˆ30ç§’ï¼‰'));
            }, 30000);

            GM_xmlhttpRequest({
                method: 'POST',
                url: `${aiConfig.baseURL}/chat/completions`,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${aiConfig.apiKey}`
                },
                data: JSON.stringify(requestBody),
                timeout: 30000,
                onload: function(response) {
                    clearTimeout(timeoutId);
                    try {
                        if (response.status !== 200) {
                            let errorMsg = `APIé”™è¯¯(${response.status})`;
                            try {
                                const errorData = JSON.parse(response.responseText);
                                errorMsg = errorData.error?.message || errorData.message || errorMsg;
                            } catch (e) {
                                errorMsg = `APIè¿”å›é”™è¯¯: ${response.status} ${response.statusText}`;
                            }
                            Logger.error('APIé”™è¯¯:', errorMsg);
                            reject(new Error(errorMsg));
                            return;
                        }

                        const data = JSON.parse(response.responseText);
                        if (data.choices && data.choices.length > 0) {
                            const answer = data.choices[0].message.content.trim();
                            resolve(answer);
                        } else if (data.error) {
                            reject(new Error(data.error.message || 'APIè¿”å›é”™è¯¯'));
                        } else {
                            reject(new Error('AIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯'));
                        }
                    } catch (error) {
                        Logger.error('è§£æå“åº”å¤±è´¥:', error);
                        reject(new Error('è§£æAIè¿”å›æ•°æ®å¤±è´¥'));
                    }
                },
                onerror: (err) => {
                    clearTimeout(timeoutId);
                    Logger.error('ç½‘ç»œé”™è¯¯:', err);
                    reject(new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥'));
                },
                ontimeout: () => {
                    clearTimeout(timeoutId);
                    reject(new Error('è¯·æ±‚è¶…æ—¶'));
                }
            });
        });
    }

    // æ„å»ºæç¤ºè¯
    function buildPrompt(question) {
        let prompt = '';
        if (question.type === 'å•é€‰é¢˜') {
            prompt = `è¿™æ˜¯ä¸€é“å•é€‰é¢˜ï¼Œè¯·ä»”ç»†åˆ†æåé€‰æ‹©æ­£ç¡®ç­”æ¡ˆã€‚

é¢˜ç›®ï¼š${question.text}

é€‰é¡¹ï¼š
`;
            question.options.forEach(opt => { prompt += `${opt.label}. ${opt.text}\n`; });
            prompt += `\nè¯·ç›´æ¥å›ç­”é€‰é¡¹å­—æ¯ï¼ˆå¦‚ï¼šA æˆ– B æˆ– C æˆ– Dï¼‰ï¼Œä¸è¦æœ‰å…¶ä»–å†…å®¹ã€‚`;
        } else if (question.type === 'å¤šé€‰é¢˜') {
            prompt = `è¿™æ˜¯ä¸€é“å¤šé€‰é¢˜ï¼Œè¯·ä»”ç»†åˆ†æåé€‰æ‹©æ‰€æœ‰æ­£ç¡®ç­”æ¡ˆã€‚

é¢˜ç›®ï¼š${question.text}

é€‰é¡¹ï¼š
`;
            question.options.forEach(opt => { prompt += `${opt.label}. ${opt.text}\n`; });
            prompt += `\nè¯·ç›´æ¥å›ç­”é€‰é¡¹å­—æ¯ï¼Œå¤šä¸ªç­”æ¡ˆç”¨é€—å·åˆ†éš”ï¼ˆå¦‚ï¼šA,C,Dï¼‰ï¼Œä¸è¦æœ‰å…¶ä»–å†…å®¹ã€‚`;
        } else if (question.type === 'åˆ¤æ–­é¢˜') {
            prompt = `è¿™æ˜¯ä¸€é“åˆ¤æ–­é¢˜ï¼Œè¯·åˆ¤æ–­å¯¹é”™ã€‚

é¢˜ç›®ï¼š${question.text}

`;
            if (question.options.length > 0) {
                prompt += `é€‰é¡¹ï¼š\n`;
                question.options.forEach(opt => { prompt += `${opt.label}. ${opt.text}\n`; });
                prompt += `\nè¯·ç›´æ¥å›ç­”é€‰é¡¹å­—æ¯ï¼ˆå¦‚ï¼šA æˆ– Bï¼‰ï¼Œä¸è¦æœ‰å…¶ä»–å†…å®¹ã€‚`;
            } else {
                prompt += `\nè¯·ç›´æ¥å›ç­”"å¯¹"æˆ–"é”™"ï¼Œä¸è¦æœ‰å…¶ä»–å†…å®¹ã€‚`;
            }
        } else if (question.type === 'å¡«ç©ºé¢˜') {
            prompt = `è¿™æ˜¯ä¸€é“å¡«ç©ºé¢˜ï¼Œè¯·ç»™å‡ºå‡†ç¡®ç­”æ¡ˆã€‚

é¢˜ç›®ï¼š${question.text}

`;
            if (question.options && question.options.length > 0) {
                prompt += `å‚è€ƒé€‰é¡¹ï¼š\n`;
                question.options.forEach(opt => { prompt += `${opt.label}. ${opt.text}\n`; });
                prompt += `\n`;
            }
            const blankCount = question.fillInputs.length;
            if (blankCount > 1) {
                prompt += `æ³¨æ„ï¼šè¿™é“é¢˜æœ‰ ${blankCount} ä¸ªç©ºéœ€è¦å¡«å†™ã€‚\n`;
                prompt += `è¯·æŒ‰é¡ºåºç»™å‡ºæ‰€æœ‰ç©ºçš„ç­”æ¡ˆï¼Œæ¯ä¸ªç­”æ¡ˆä¹‹é—´ç”¨åˆ†å·(;)åˆ†éš”ã€‚\nä¾‹å¦‚ï¼šç­”æ¡ˆ1;ç­”æ¡ˆ2;ç­”æ¡ˆ3\n\n`;
            }
            prompt += `è¦æ±‚ï¼š\n1. åªè¿”å›ç­”æ¡ˆå†…å®¹ï¼Œä¸è¦æœ‰ä»»ä½•è§£é‡Šæˆ–å…¶ä»–æ–‡å­—\n2. å¦‚æœæœ‰å¤šä¸ªç©ºï¼ŒåŠ¡å¿…ç”¨åˆ†å·(;)åˆ†éš”\n3. ç­”æ¡ˆè¦å‡†ç¡®ç®€æ´`;
        }
        return prompt;
    }

    // é€‰æ‹©ç­”æ¡ˆ
    async function selectAnswer(question, answer) {
        if (!answer) {
            updateExamMessage('æœªæ‰¾åˆ°ç­”æ¡ˆï¼Œè·³è¿‡æ­¤é¢˜', '#f59e0b');
            return false;
        }
        try {
            if (question.type === 'å•é€‰é¢˜' || question.type === 'åˆ¤æ–­é¢˜') {
                const matchedOption = question.options.find(opt => {
                    return answer.includes(opt.label) || answer.includes(opt.text) || opt.text.includes(answer);
                });
                if (matchedOption) {
                    const radioInput = matchedOption.element.querySelector('input[type="radio"]');
                    if (radioInput) {
                        radioInput.click();
                        updateExamMessage(`å·²é€‰æ‹©ç­”æ¡ˆï¼š${matchedOption.label}`, '#10b981');
                        return true;
                    }
                }
            } else if (question.type === 'å¤šé€‰é¢˜') {
                const answerLabels = answer.match(/[A-Z]/g) || [];
                let selectedCount = 0;
                for (let i = 0; i < answerLabels.length; i++) {
                    const label = answerLabels[i];
                    const matchedOption = question.options.find(opt => opt.label === label);
                    if (matchedOption) {
                        // å°è¯•å¤šç§æ–¹å¼æ‰¾åˆ°checkbox
                        let checkboxInput = matchedOption.element.querySelector('input[type="checkbox"]');
                        if (!checkboxInput) {
                            checkboxInput = matchedOption.element.querySelector('.ivu-checkbox-input');
                        }
                        if (!checkboxInput) {
                            // ç›´æ¥ç‚¹å‡»wrapperå…ƒç´ 
                            matchedOption.element.click();
                            selectedCount++;
                        } else if (!checkboxInput.checked) {
                            checkboxInput.click();
                            selectedCount++;
                        }
                        // æ¯æ¬¡ç‚¹å‡»åç­‰å¾…ä¸€ä¸‹ï¼Œç¡®ä¿çŠ¶æ€æ›´æ–°
                        await Utils.sleep(200);
                    }
                }
                if (selectedCount > 0) {
                    updateExamMessage(`å·²é€‰æ‹©ç­”æ¡ˆï¼š${answerLabels.join(', ')}`, '#10b981');
                    return true;
                }
            } else if (question.type === 'å¡«ç©ºé¢˜') {
                if (question.fillInputs.length > 0) {
                    const answers = answer.split(/[;ï¼›]/).map(a => a.trim()).filter(a => a);
                    let filledCount = 0;
                    question.fillInputs.forEach((input, index) => {
                        if (answers[index]) {
                            input.value = answers[index];
                            input.dispatchEvent(new Event('input', { bubbles: true }));
                            input.dispatchEvent(new Event('change', { bubbles: true }));
                            input.dispatchEvent(new Event('blur', { bubbles: true }));
                            filledCount++;
                        }
                    });
                    if (filledCount > 0) {
                        updateExamMessage(`å·²å¡«å…¥ ${filledCount} ä¸ªç­”æ¡ˆ`, '#10b981');
                        return true;
                    }
                }
            }
            updateExamMessage('ç­”æ¡ˆæ ¼å¼ä¸åŒ¹é…ï¼Œè·³è¿‡æ­¤é¢˜', '#f59e0b');
            return false;
        } catch (error) {
            return false;
        }
    }

    // ç‚¹å‡»ä¸‹ä¸€é¢˜æŒ‰é’®
    function clickNextButton() {
        const nextBtn = Array.from(document.querySelectorAll('button')).find(btn => btn.textContent.includes('ä¸‹ä¸€é¢˜'));
        if (nextBtn && !nextBtn.disabled) {
            setTimeout(() => {
                nextBtn.click();
                updateExamMessage('å·²ç‚¹å‡»ä¸‹ä¸€é¢˜', '#2196F3');
            }, 500);
            return true;
        }
        return false;
    }

    // ç‚¹å‡»äº¤å·æŒ‰é’®
    async function clickSubmitButton() {
        const submitBtn = Array.from(document.querySelectorAll('button')).find(btn => btn.textContent.includes('äº¤å·'));
        if (submitBtn && !submitBtn.disabled) {
            if (CONFIG.exam.autoSubmit) {
                updateExamMessage('æ­£åœ¨è‡ªåŠ¨äº¤å·...', '#10b981');
                await Utils.sleep(1000);
                submitBtn.click();
                await Utils.sleep(1500);
                const confirmed = await clickConfirmSubmit();
                if (confirmed) {
                    updateExamMessage('å·²è‡ªåŠ¨ç¡®è®¤æäº¤', '#10b981');
                }
            } else {
                updateExamMessage('æ‰€æœ‰é¢˜ç›®å·²å®Œæˆï¼Œè¯·æ‰‹åŠ¨äº¤å·', '#10b981');
            }
            return true;
        }
        return false;
    }

    // ç¡®è®¤æäº¤
    async function clickConfirmSubmit() {
        for (let i = 0; i < 10; i++) {
            let confirmBtn = Array.from(document.querySelectorAll('button')).find(btn => btn.textContent.includes('ç¡®è®¤æäº¤'));
            if (!confirmBtn) {
                const footer = document.querySelector('.ivu-modal-confirm-footer');
                if (footer) confirmBtn = footer.querySelector('.ivu-btn-primary');
            }
            if (!confirmBtn) {
                const modal = document.querySelector('.ivu-modal-confirm');
                if (modal) confirmBtn = modal.querySelector('.ivu-btn-primary');
            }
            if (confirmBtn) {
                await Utils.sleep(500);
                confirmBtn.click();
                await Utils.sleep(2000);
                await clickClosePage();
                return true;
            }
            await Utils.sleep(100);
        }
        return false;
    }

    // å…³é—­é¡µé¢
    async function clickClosePage() {
        for (let i = 0; i < 15; i++) {
            let closeBtn = Array.from(document.querySelectorAll('button')).find(btn =>
                btn.textContent.includes('å…³é—­é¡µé¢') || btn.textContent.includes('å…³é—­')
            );
            if (!closeBtn) {
                const footer = document.querySelector('.ivu-modal-confirm-footer');
                if (footer) {
                    const primaryBtn = footer.querySelector('.ivu-btn-primary');
                    if (primaryBtn && (primaryBtn.textContent.includes('å…³é—­') || primaryBtn.textContent.includes('ç¡®å®š'))) {
                        closeBtn = primaryBtn;
                    }
                }
            }
            if (closeBtn) {
                await Utils.sleep(500);
                closeBtn.click();
                updateExamMessage('å·²å®Œæˆå¹¶å…³é—­é¡µé¢', '#10b981');
                return true;
            }
            await Utils.sleep(200);
        }
        return false;
    }

    // ä¸»ç­”é¢˜å¾ªç¯
    async function answerQuestions() {
        while (state.exam.isRunning) {
            try {
                const question = getCurrentQuestion();
                if (!question || !question.text) {
                    const submitted = await clickSubmitButton();
                    if (submitted) break;
                    await Utils.sleep(2000);
                    break;
                }
                state.exam.currentQuestionIndex++;
                updateExamProgress();

                // è®°å½•é¢˜ç›®ä¿¡æ¯
                const shortQuestion = question.text.length > 50 ? question.text.substring(0, 50) + '...' : question.text;
                Logger.info(`ã€ç¬¬${state.exam.currentQuestionIndex}é¢˜-${question.type}ã€‘${shortQuestion}`);

                // è®°å½•é€‰é¡¹
                if (question.options.length > 0) {
                    const optionsText = question.options.map(opt => `${opt.label}.${opt.text}`).join(' | ');
                    const shortOptions = optionsText.length > 80 ? optionsText.substring(0, 80) + '...' : optionsText;
                    Logger.info(`é€‰é¡¹: ${shortOptions}`);
                }

                updateExamMessage(`æ­£åœ¨å¤„ç†ç¬¬ ${state.exam.currentQuestionIndex} é¢˜ (${question.type})...`, '#2196F3');

                // æŸ¥è¯¢ç­”æ¡ˆï¼ˆå¸¦è¶…æ—¶ä¿æŠ¤ï¼‰
                const answer = await searchAnswer(question);

                if (answer) {
                    Logger.success(`AIç­”æ¡ˆ: ${answer}`);
                    await selectAnswer(question, answer);
                    updateExamMessage(`âœ… ç¬¬ ${state.exam.currentQuestionIndex} é¢˜å·²å®Œæˆ`, '#10b981');
                } else {
                    Logger.warn(`ç¬¬${state.exam.currentQuestionIndex}é¢˜æœªè·å–åˆ°ç­”æ¡ˆ`);
                    updateExamMessage(`âš ï¸ ç¬¬ ${state.exam.currentQuestionIndex} é¢˜æœªæ‰¾åˆ°ç­”æ¡ˆï¼Œè·³è¿‡`, '#f59e0b');
                }

                await Utils.sleep(CONFIG.exam.delay);

                const hasNext = clickNextButton();
                if (!hasNext) {
                    await Utils.sleep(1000);
                    await clickSubmitButton();
                    break;
                }
                await Utils.sleep(1000);
            } catch (error) {
                // æ•è·ä»»ä½•é”™è¯¯ï¼Œç¡®ä¿ä¸ä¼šå¡ä½
                Logger.error('ç­”é¢˜å‡ºé”™:', error);
                updateExamMessage(`âŒ ç¬¬ ${state.exam.currentQuestionIndex} é¢˜å‡ºé”™: ${error.message}`, '#ef4444');
                await Utils.sleep(2000);
                // å°è¯•ç‚¹å‡»ä¸‹ä¸€é¢˜ç»§ç»­
                const hasNext = clickNextButton();
                if (!hasNext) break;
                await Utils.sleep(1000);
            }
        }
        state.exam.isRunning = false;
        document.getElementById('exam-start').disabled = false;
        document.getElementById('exam-stop').disabled = true;
        Logger.info('ç­”é¢˜å®Œæˆ');
    }

    // å¼€å§‹ç­”é¢˜
    async function startExam() {
        if (state.exam.isRunning) return;

        const aiConfig = getAIConfig();
        if (!aiConfig.apiKey || aiConfig.apiKey === '') {
            updateExamMessage('âŒ è¯·å…ˆé…ç½®API Key', '#ef4444');
            return;
        }

        state.exam.isRunning = true;
        state.exam.currentQuestionIndex = 0;
        state.exam.totalQuestions = getTotalQuestions();

        document.getElementById('exam-start').disabled = true;
        document.getElementById('exam-stop').disabled = false;
        document.getElementById('exam-status').textContent = 'ğŸŸ¢ è¿è¡Œä¸­';

        updateExamMessage(`å¼€å§‹AIç­”é¢˜ï¼ˆä½¿ç”¨ ${AI_PRESETS[CONFIG.exam.currentAI].name}ï¼‰...`, '#10b981');
        updateExamProgress();

        await answerQuestions();
    }

    // åœæ­¢ç­”é¢˜
    function stopExam() {
        state.exam.isRunning = false;
        document.getElementById('exam-start').disabled = false;
        document.getElementById('exam-stop').disabled = true;
        document.getElementById('exam-status').textContent = 'â¸ï¸ å·²åœæ­¢';

        updateExamMessage('å·²åœæ­¢ç­”é¢˜', '#f59e0b');
    }

    // è·å–æ€»é¢˜æ•°
    function getTotalQuestions() {
        const answerCard = document.querySelector('.topic-zpx-list');
        if (answerCard) {
            const questionSpans = answerCard.querySelectorAll('.topic-zpx-main span');
            return questionSpans.length;
        }
        return 0;
    }

    // æ›´æ–°è¿›åº¦
    function updateExamProgress() {
        document.getElementById('exam-progress').textContent =
            `${state.exam.currentQuestionIndex}/${state.exam.totalQuestions}`;

        const percentage = state.exam.totalQuestions > 0
            ? (state.exam.currentQuestionIndex / state.exam.totalQuestions * 100)
            : 0;
        const progressBar = document.getElementById('exam-progress-bar');
        if (progressBar) {
            progressBar.style.width = `${percentage}%`;
            progressBar.setAttribute('data-progress', `${Math.round(percentage)}%`);
        }
    }

    // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
    function updateExamMessage(text, color = '#64748b') {
        const msg = document.getElementById('exam-message');
        if (msg) {
            msg.textContent = text;
            msg.style.color = color;
        }
    }

    // ==================== åˆå§‹åŒ– ====================
    function init() {
        // åˆ›å»ºé¢æ¿
        createPanel();
        
        // åˆå§‹åŒ–æ—¥å¿—è®¡æ•°å™¨
        updateLogCount();
    }
    
    // æ›´æ–°æ—¥å¿—è®¡æ•°å™¨
    function updateLogCount() {
        const logCountElement = document.getElementById('log-count');
        if (logCountElement) {
            logCountElement.textContent = `${Logger._logs.length} æ¡è®°å½•`;
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(init, 1000);
        });
    } else {
        setTimeout(init, 1000);
    }

})();
